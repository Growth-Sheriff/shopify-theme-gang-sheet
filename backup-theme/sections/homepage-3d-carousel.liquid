{% comment %}
  3D Product Carousel - Product Bar Style + 4D Effects + Block-based Products
  Features: 4D hover effects, gold foil header, individual product blocks, My Device upload, Add to Cart
{% endcomment %}

{{ 'homepage-3d-carousel.css' | asset_url | stylesheet_tag }}

<section class="carousel-3d-section" id="carousel3d-{{ section.id }}">
  <!-- 4D Gold Foil Header -->
  <div class="section-header-4d">
    <div class="header-4d-container">
      <div class="header-sparkles">
        {% for i in (1..20) %}
          <div class="sparkle" style="--delay: {{ i | times: 0.15 }}s; --x: {{ i | times: 5 }}%;"></div>
        {% endfor %}
      </div>
      <div class="header-4d-inner">
        <span class="header-tag">{{ section.settings.header_tag | default: '✨ LIMITED TIME' }}</span>
        <h2 class="header-title-4d">{{ section.settings.title | default: 'BLACK FRIDAY' }}</h2>
        <p class="header-subtitle">{{ section.settings.subtitle | default: 'Exclusive deals on premium products' }}</p>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- 3D Carousel -->
    <div class="carousel-3d-wrapper">
      <div class="carousel-3d" id="carousel3d-inner-{{ section.id }}">
        {% for block in section.blocks %}
          {% if block.type == 'product' %}
            {% assign product = block.settings.product %}
            <div class="carousel-3d-item" data-index="{{ forloop.index0 }}" {{ block.shopify_attributes }}>
              <div class="product-card-4d" data-product-id="{{ product.id }}">
                <!-- 4D Layers -->
                <div class="card-4d-layers">
                  <div class="layer layer-1"></div>
                  <div class="layer layer-2"></div>
                  <div class="layer layer-3"></div>
                </div>
                
                <div class="card-inner">
                  <!-- Badges -->
                  <div class="card-badges">
                    {% if block.settings.show_4d_badge %}
                      <span class="badge badge-4d">
                        <span class="badge-4d-text">4D</span>
                      </span>
                    {% endif %}
                    {% if product.compare_at_price > product.price %}
                      {% assign discount = product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price | round %}
                      <span class="badge badge-discount">{{ discount }}% OFF</span>
                    {% endif %}
                    {% if block.settings.custom_badge != blank %}
                      <span class="badge badge-custom" style="background: {{ block.settings.badge_color }};">{{ block.settings.custom_badge }}</span>
                    {% endif %}
                  </div>
                  
                  <!-- Wishlist -->
                  <button class="wishlist-btn" aria-label="Add to wishlist">
                    <i class="fa-regular fa-heart"></i>
                  </button>
                  
                  <!-- Product Image with 4D Effect -->
                  <div class="product-image-4d">
                    <div class="image-4d-container">
                      {% if product.featured_image %}
                        <img src="{{ product.featured_image | image_url: width: 500 }}" 
                             alt="{{ product.title }}"
                             width="500" height="500"
                             loading="lazy"
                             class="product-img">
                      {% else %}
                        <div class="placeholder-img">
                          <i class="fa-solid fa-image"></i>
                        </div>
                      {% endif %}
                      
                      <!-- 4D Floating Elements -->
                      <div class="floating-elements">
                        <div class="float-circle float-1"></div>
                        <div class="float-circle float-2"></div>
                        <div class="float-circle float-3"></div>
                      </div>
                      
                      <!-- Glow Effect -->
                      <div class="image-glow"></div>
                    </div>
                    
                    <!-- Perfect For Label -->
                    {% if block.settings.perfect_for != blank %}
                      <div class="perfect-for-label">
                        <span>Perfect for:</span>
                        <strong>{{ block.settings.perfect_for }}</strong>
                      </div>
                    {% endif %}
                  </div>
                  
                  <!-- Product Info -->
                  <div class="product-info">
                    {% if product.vendor %}
                      <span class="product-vendor">{{ product.vendor }}</span>
                    {% endif %}
                    
                    <h3 class="product-title">{{ product.title | default: 'Product Title' | truncate: 50 }}</h3>
                    
                    <!-- Rating -->
                    <div class="product-rating">
                      {% assign rating = block.settings.rating | default: 5 %}
                      <div class="stars">
                        {% for i in (1..5) %}
                          {% if i <= rating %}
                            <i class="fa-solid fa-star"></i>
                          {% else %}
                            <i class="fa-regular fa-star"></i>
                          {% endif %}
                        {% endfor %}
                      </div>
                      <span class="rating-count">({{ block.settings.review_count | default: 0 }})</span>
                    </div>
                    
                    <!-- Price -->
                    <div class="product-price">
                      {% if product.compare_at_price > product.price %}
                        <span class="compare-price">{{ product.compare_at_price | money }}</span>
                      {% endif %}
                      <span class="current-price">{{ product.price | money }}</span>
                    </div>
                    
                    <!-- Upload Area (My Device) -->
                    {% if block.settings.show_upload %}
                      <div class="upload-area">
                        <button class="upload-btn" type="button">
                          <i class="fa-solid fa-rotate"></i>
                          <span>{{ block.settings.upload_text | default: 'My Device' }}</span>
                        </button>
                      </div>
                    {% endif %}
                    
                    <!-- Add to Cart -->
                    <div class="product-actions">
                      {% if product.available %}
                        <button class="add-to-cart-btn" data-variant-id="{{ product.first_available_variant.id }}">
                          <i class="fa-solid fa-cart-plus"></i>
                          <span>Add to Cart</span>
                        </button>
                      {% else %}
                        <button class="soldout-btn" disabled>
                          <span>Sold Out</span>
                        </button>
                      {% endif %}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
        
        {% if section.blocks.size == 0 %}
          <!-- Demo Products when no blocks -->
          {% for i in (1..5) %}
            <div class="carousel-3d-item" data-index="{{ forloop.index0 }}">
              <div class="product-card-4d">
                <div class="card-4d-layers">
                  <div class="layer layer-1"></div>
                  <div class="layer layer-2"></div>
                  <div class="layer layer-3"></div>
                </div>
                <div class="card-inner">
                  <div class="card-badges">
                    <span class="badge badge-4d"><span class="badge-4d-text">4D</span></span>
                    <span class="badge badge-discount">20% OFF</span>
                  </div>
                  <button class="wishlist-btn"><i class="fa-regular fa-heart"></i></button>
                  <div class="product-image-4d">
                    <div class="image-4d-container">
                      <div class="placeholder-img"><i class="fa-solid fa-image"></i></div>
                      <div class="floating-elements">
                        <div class="float-circle float-1"></div>
                        <div class="float-circle float-2"></div>
                      </div>
                      <div class="image-glow"></div>
                    </div>
                  </div>
                  <div class="product-info">
                    <span class="product-vendor">Brand Name</span>
                    <h3 class="product-title">Sample Product {{ i }}</h3>
                    <div class="product-rating">
                      <div class="stars">
                        <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
                        <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
                        <i class="fa-solid fa-star-half-stroke"></i>
                      </div>
                      <span class="rating-count">(128)</span>
                    </div>
                    <div class="product-price">
                      <span class="compare-price">$9.99</span>
                      <span class="current-price">$4.99</span>
                    </div>
                    <div class="upload-area">
                      <button class="upload-btn"><i class="fa-solid fa-rotate"></i><span>My Device</span></button>
                    </div>
                    <div class="product-actions">
                      <button class="add-to-cart-btn"><i class="fa-solid fa-cart-plus"></i><span>Add to Cart</span></button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        {% endif %}
      </div>
      
      <!-- Navigation -->
      <button class="carousel-nav carousel-prev" aria-label="Previous">
        <i class="fa-solid fa-chevron-left"></i>
      </button>
      <button class="carousel-nav carousel-next" aria-label="Next">
        <i class="fa-solid fa-chevron-right"></i>
      </button>
      
      <!-- Dots -->
      <div class="carousel-dots"></div>
    </div>
  </div>
  
  <!-- Ambient Particles -->
  <div class="ambient-particles"></div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const section = document.getElementById('carousel3d-{{ section.id }}');
  if (!section) return;
  
  const carousel = section.querySelector('.carousel-3d');
  const items = carousel.querySelectorAll('.carousel-3d-item');
  const dotsContainer = section.querySelector('.carousel-dots');
  const prevBtn = section.querySelector('.carousel-prev');
  const nextBtn = section.querySelector('.carousel-next');
  
  if (items.length === 0) return;
  
  let currentIndex = 0;
  const totalItems = items.length;
  const radius = 400;
  const autoPlayDelay = {{ section.settings.autoplay_speed | default: 5000 }};
  let autoPlayInterval;
  
  // Create dots
  items.forEach((_, i) => {
    const dot = document.createElement('button');
    dot.className = 'carousel-dot' + (i === 0 ? ' active' : '');
    dot.addEventListener('click', () => { goToSlide(i); resetAutoPlay(); });
    dotsContainer.appendChild(dot);
  });
  
  const dots = dotsContainer.querySelectorAll('.carousel-dot');
  
  function updateCarousel() {
    const angleStep = 360 / totalItems;
    items.forEach((item, i) => {
      const offset = i - currentIndex;
      let angle = offset * angleStep;
      if (angle > 180) angle -= 360;
      if (angle < -180) angle += 360;
      
      const radian = (angle * Math.PI) / 180;
      const translateX = Math.sin(radian) * radius;
      const translateZ = Math.cos(radian) * radius - radius;
      const scale = (translateZ + radius * 2) / (radius * 2.5);
      const opacity = Math.max(0.3, scale);
      
      item.style.transform = `translateX(${translateX}px) translateZ(${translateZ}px) scale(${0.6 + scale * 0.5})`;
      item.style.opacity = opacity;
      item.style.zIndex = Math.round(scale * 100);
      item.style.filter = i === currentIndex ? 'none' : `blur(${Math.abs(offset)}px)`;
      item.classList.toggle('active', i === currentIndex);
    });
    
    dots.forEach((dot, i) => dot.classList.toggle('active', i === currentIndex));
  }
  
  function goToSlide(index) {
    currentIndex = ((index % totalItems) + totalItems) % totalItems;
    updateCarousel();
  }
  
  function nextSlide() { goToSlide(currentIndex + 1); }
  function prevSlide() { goToSlide(currentIndex - 1); }
  
  prevBtn?.addEventListener('click', () => { prevSlide(); resetAutoPlay(); });
  nextBtn?.addEventListener('click', () => { nextSlide(); resetAutoPlay(); });
  
  // Touch/Drag
  let startX = 0, isDragging = false;
  carousel.addEventListener('mousedown', e => { isDragging = true; startX = e.clientX; });
  carousel.addEventListener('touchstart', e => { isDragging = true; startX = e.touches[0].clientX; }, {passive: true});
  document.addEventListener('mouseup', handleDragEnd);
  document.addEventListener('touchend', handleDragEnd);
  
  function handleDragEnd(e) {
    if (!isDragging) return;
    isDragging = false;
    const endX = e.type === 'touchend' ? e.changedTouches[0].clientX : e.clientX;
    const diff = startX - endX;
    if (Math.abs(diff) > 50) {
      diff > 0 ? nextSlide() : prevSlide();
    }
    resetAutoPlay();
  }
  
  // 4D Tilt Effect
  document.querySelectorAll('.product-card-4d').forEach(card => {
    card.addEventListener('mousemove', e => {
      const rect = card.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width - 0.5;
      const y = (e.clientY - rect.top) / rect.height - 0.5;
      
      card.style.transform = `perspective(1000px) rotateY(${x * 15}deg) rotateX(${-y * 15}deg)`;
      
      const glow = card.querySelector('.image-glow');
      if (glow) {
        glow.style.opacity = '1';
        glow.style.background = `radial-gradient(circle at ${(x + 0.5) * 100}% ${(y + 0.5) * 100}%, rgba(102, 126, 234, 0.4), transparent 60%)`;
      }
    });
    
    card.addEventListener('mouseleave', () => {
      card.style.transform = '';
      const glow = card.querySelector('.image-glow');
      if (glow) glow.style.opacity = '0';
    });
  });
  
  // Add to Cart
  section.querySelectorAll('.add-to-cart-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const variantId = btn.dataset.variantId;
      if (!variantId) return;
      
      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
      
      try {
        const res = await fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: variantId, quantity: 1 })
        });
        
        if (res.ok) {
          btn.innerHTML = '<i class="fa-solid fa-check"></i> Added!';
          btn.classList.add('success');
          const cartRes = await fetch('/cart.js');
          const cart = await cartRes.json();
          document.querySelectorAll('.cart-count').forEach(el => el.textContent = cart.item_count);
          setTimeout(() => {
            btn.innerHTML = '<i class="fa-solid fa-cart-plus"></i><span>Add to Cart</span>';
            btn.classList.remove('success');
            btn.disabled = false;
          }, 2000);
        }
      } catch (err) {
        btn.innerHTML = '<i class="fa-solid fa-times"></i> Error';
        setTimeout(() => {
          btn.innerHTML = '<i class="fa-solid fa-cart-plus"></i><span>Add to Cart</span>';
          btn.disabled = false;
        }, 2000);
      }
    });
  });
  
  // Autoplay
  function startAutoPlay() {
    if ({{ section.settings.autoplay | json }}) {
      autoPlayInterval = setInterval(nextSlide, autoPlayDelay);
    }
  }
  function resetAutoPlay() {
    clearInterval(autoPlayInterval);
    startAutoPlay();
  }
  
  section.addEventListener('mouseenter', () => clearInterval(autoPlayInterval));
  section.addEventListener('mouseleave', startAutoPlay);
  
  // Particles
  const particles = section.querySelector('.ambient-particles');
  for (let i = 0; i < 20; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.cssText = `left:${Math.random()*100}%;animation-delay:${Math.random()*10}s;animation-duration:${10+Math.random()*10}s;width:${3+Math.random()*5}px;height:${3+Math.random()*5}px;`;
    particles.appendChild(p);
  }
  
  // Init
  updateCarousel();
  startAutoPlay();
});
</script>

{% schema %}
{
  "name": "3D Carousel 4D",
  "tag": "section",
  "class": "section-3d-carousel-4d",
  "settings": [
    {
      "type": "header",
      "content": "4D Header"
    },
    {
      "type": "text",
      "id": "header_tag",
      "label": "Header Tag",
      "default": "✨ LIMITED TIME"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "BLACK FRIDAY"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Exclusive deals on premium products"
    },
    {
      "type": "header",
      "content": "Carousel Settings"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Auto-play",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 2000,
      "max": 8000,
      "step": 1000,
      "default": 5000,
      "unit": "ms",
      "label": "Auto-play speed"
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "header",
          "content": "Badges"
        },
        {
          "type": "checkbox",
          "id": "show_4d_badge",
          "label": "Show 4D Badge",
          "default": true
        },
        {
          "type": "text",
          "id": "custom_badge",
          "label": "Custom Badge Text"
        },
        {
          "type": "color",
          "id": "badge_color",
          "label": "Custom Badge Color",
          "default": "#28c76f"
        },
        {
          "type": "header",
          "content": "Rating"
        },
        {
          "type": "range",
          "id": "rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "default": 5,
          "label": "Star Rating"
        },
        {
          "type": "number",
          "id": "review_count",
          "label": "Review Count",
          "default": 128
        },
        {
          "type": "header",
          "content": "Features"
        },
        {
          "type": "checkbox",
          "id": "show_upload",
          "label": "Show Upload Button",
          "default": true
        },
        {
          "type": "text",
          "id": "upload_text",
          "label": "Upload Button Text",
          "default": "My Device"
        },
        {
          "type": "text",
          "id": "perfect_for",
          "label": "Perfect For Label",
          "placeholder": "e.g., Hoodies, T-Shirts"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "3D Carousel 4D",
      "category": "Products",
      "blocks": [
        { "type": "product" },
        { "type": "product" },
        { "type": "product" },
        { "type": "product" },
        { "type": "product" }
      ]
    }
  ]
}
{% endschema %}
