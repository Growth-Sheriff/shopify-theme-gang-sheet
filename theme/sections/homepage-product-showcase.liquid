{% comment %}
  ============================================
  HOMEPAGE PRODUCT SHOWCASE SECTION
  - 4D Gold Foil Header
  - Block-based Products (Left 4 + Right 1)
  - 4D Hover Effects on Cards
  - My Device Upload + Quick Add Buttons
  ============================================
{% endcomment %}

{%- render 'custom-css-renderer', section: section -%}

{{ 'homepage-product-showcase.css' | asset_url | stylesheet_tag }}

<section class="product-showcase-section py-3" id="showcase-{{ section.id }}">
  <div class="container">
    
    {%- comment -%} ===== 4D GOLD FOIL HEADER ===== {%- endcomment -%}
    <div class="showcase-4d-header mb-3">
      {%- comment -%} Decorative Side Lines {%- endcomment -%}
      <div class="header-deco-wrapper">
        <div class="header-side-line line-left">
          <span class="line-dot"></span>
          <span class="line-bar"></span>
          <span class="line-end"></span>
        </div>
        
        <div class="gold-foil-container">
          {%- comment -%} Corner Accents {%- endcomment -%}
          <span class="corner-accent top-left"></span>
          <span class="corner-accent top-right"></span>
          <span class="corner-accent bottom-left"></span>
          <span class="corner-accent bottom-right"></span>
          
          <div class="gold-particles">
            {%- for i in (1..15) -%}
              <span class="particle particle-{{ i }}"></span>
            {%- endfor -%}
          </div>
          <div class="gold-foil-text">
            <span class="foil-layer layer-1">{{ section.settings.header_text | default: 'SPECIAL OFFERS' }}</span>
            <span class="foil-layer layer-2">{{ section.settings.header_text | default: 'SPECIAL OFFERS' }}</span>
            <span class="foil-layer layer-3">{{ section.settings.header_text | default: 'SPECIAL OFFERS' }}</span>
          </div>
          <div class="gold-shine"></div>
        </div>
        
        <div class="header-side-line line-right">
          <span class="line-end"></span>
          <span class="line-bar"></span>
          <span class="line-dot"></span>
        </div>
      </div>
      
      {%- if section.settings.subtitle != blank -%}
        <p class="showcase-subtitle text-center mt-3">{{ section.settings.subtitle }}</p>
      {%- endif -%}
    </div>

    {%- comment -%} ===== SHOWCASE LAYOUT (4 LEFT + 1 RIGHT) ===== {%- endcomment -%}
    <div class="showcase-wrapper">
      <div class="row g-2">
        
        {%- comment -%} LEFT SIDE - 4 PRODUCTS GRID {%- endcomment -%}
        <div class="col-lg-7">
          <div class="row g-2">
            {%- assign left_count = 0 -%}
            {%- for block in section.blocks -%}
              {%- if block.type == 'left_product' and left_count < 4 -%}
                {%- assign product = block.settings.product -%}
                {%- if product != blank -%}
                  {%- assign left_count = left_count | plus: 1 -%}
                  <div class="col-6" {{ block.shopify_attributes }}>
                    <div class="showcase-card showcase-card-4d {% if block.settings.enable_4d %}has-4d-effect{% endif %}" 
                         data-4d="{{ block.settings.enable_4d }}">
                      
                      {%- if block.settings.enable_4d -%}
                        <div class="badge-4d">
                          <span>{{ block.settings.badge_text | default: '4D' }}</span>
                        </div>
                      {%- endif -%}
                      
                      {%- if product.compare_at_price > product.price -%}
                        {%- assign discount = product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price -%}
                        <div class="discount-badge">-{{ discount }}%</div>
                      {%- endif -%}

                      <a href="{{ product.url }}" class="showcase-card-link">
                        <div class="showcase-card-image">
                          {%- if product.featured_image != blank -%}
                            <img src="{{ product.featured_image | image_url: width: 400 }}" 
                                 alt="{{ product.title | escape }}"
                                 width="400"
                                 height="400"
                                 loading="lazy"
                                 style="width:100%;height:100%;object-fit:cover;display:block;">
                          {%- else -%}
                            <div class="placeholder-image" style="width:100%;height:140px;display:flex;align-items:center;justify-content:center;background:#f0f0f0;">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="#bbb" style="width:48px;height:48px;">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                              </svg>
                            </div>
                          {%- endif -%}
                          <div class="image-shine"></div>
                        </div>
                      </a>

                      <div class="showcase-card-body">
                        {%- if product.vendor != blank -%}
                          <span class="product-vendor">{{ product.vendor }}</span>
                        {%- endif -%}
                        
                        <h4 class="product-title">
                          <a href="{{ product.url }}">{{ product.title | truncate: 35 }}</a>
                        </h4>
                        
                        {%- comment -%} STAR RATING {%- endcomment -%}
                        <div class="product-rating">
                          {%- assign rating = block.settings.rating | default: 5 -%}
                          {%- for i in (1..5) -%}
                            {%- if i <= rating -%}
                              <i class="ti ti-star-filled"></i>
                            {%- else -%}
                              <i class="ti ti-star"></i>
                            {%- endif -%}
                          {%- endfor -%}
                          <span class="rating-count">({{ block.settings.review_count | default: 0 }})</span>
                        </div>

                        <div class="product-price">
                          {%- if product.compare_at_price > product.price -%}
                            <span class="price-compare">{{ product.compare_at_price | money }}</span>
                          {%- endif -%}
                          <span class="price-current">{{ product.price | money }}</span>
                        </div>

                        {%- comment -%} Upload Widget Area (Global OR Block level) {%- endcomment -%}
                        {%- assign show_upload = false -%}
                        {%- if section.settings.enable_upload_mode_global or block.settings.enable_upload_mode -%}
                          {%- assign show_upload = true -%}
                        {%- endif -%}
                        
                        {% if show_upload %}
                          <div class="upload-widget-area">
                            {% render 'dtf-quick-upload-btn', product: product, button_text: 'Upload Design' %}
                          </div>
                        {% endif %}

                        {%- comment -%} Actions (Hidden when upload mode is enabled) {%- endcomment -%}
                        {% unless show_upload %}
                        {%- assign showcase_btn_action = block.settings.button_action | default: 'default' -%}
                        {%- if showcase_btn_action == 'default' -%}
                          {%- assign showcase_btn_action = section.settings.button_action_global | default: 'add_to_cart' -%}
                        {%- endif -%}
                        
                        <div class="showcase-card-actions">
                          {% if showcase_btn_action == 'go_to_product' %}
                            <a href="{{ product.url }}" class="btn-view-product btn-full">
                              <i class="ti ti-arrow-right"></i>
                              <span>View Product</span>
                            </a>
                          {% else %}
                            <a href="{{ product.url }}" class="btn-view-product">
                              <i class="ti ti-eye"></i>
                              <span>View</span>
                            </a>
                            <form method="post" action="{{ routes.cart_add_url }}" class="quick-add-form">
                              <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                              <input type="hidden" name="quantity" value="1">
                              <button type="submit" class="btn-quick-add" {% unless product.available %}disabled{% endunless %}>
                                <i class="ti ti-shopping-cart-plus"></i>
                              </button>
                            </form>
                          {% endif %}
                        </div>
                        {% endunless %}
                      </div>
                      
                      {%- if block.settings.enable_4d -%}
                        <div class="card-4d-effect">
                          <div class="effect-glow"></div>
                          <div class="effect-particles">
                            {%- for i in (1..8) -%}
                              <span class="mini-particle p-{{ i }}"></span>
                            {%- endfor -%}
                          </div>
                        </div>
                      {%- endif -%}
                    </div>
                  </div>
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}
          </div>
        </div>

        {%- comment -%} RIGHT SIDE - MAIN FEATURED PRODUCT {%- endcomment -%}
        <div class="col-lg-5">
          {%- for block in section.blocks -%}
            {%- if block.type == 'main_product' -%}
              {%- assign product = block.settings.product -%}
              {%- if product != blank -%}
                <div class="main-showcase-card {% if block.settings.enable_4d %}has-4d-effect{% endif %}" 
                     {{ block.shopify_attributes }}
                     data-4d="{{ block.settings.enable_4d }}">
                  
                  {%- if block.settings.enable_4d -%}
                    <div class="badge-4d badge-4d-large">
                      <span>{{ block.settings.badge_text | default: '4D PREMIUM' }}</span>
                    </div>
                  {%- endif -%}
                  
                  {%- if product.compare_at_price > product.price -%}
                    {%- assign discount = product.compare_at_price | minus: product.price | times: 100 | divided_by: product.compare_at_price -%}
                    <div class="discount-badge discount-badge-large">-{{ discount }}%</div>
                  {%- endif -%}

                  <a href="{{ product.url }}" class="main-card-link">
                    <div class="main-card-image">
                      {%- if product.featured_image != blank -%}
                        <img src="{{ product.featured_image | image_url: width: 800 }}" 
                             alt="{{ product.title | escape }}"
                             width="800"
                             height="800"
                             loading="lazy"
                             class="img-fluid">
                      {%- else -%}
                        <div class="placeholder-image placeholder-large">
                          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <circle cx="8.5" cy="8.5" r="1.5"></circle>
                            <polyline points="21 15 16 10 5 21"></polyline>
                          </svg>
                        </div>
                      {%- endif -%}
                      <div class="image-shine"></div>
                    </div>
                  </a>

                  <div class="main-card-body">
                    {%- if product.vendor != blank -%}
                      <span class="product-vendor">{{ product.vendor }}</span>
                    {%- endif -%}
                    
                    <h3 class="product-title-main">
                      <a href="{{ product.url }}">{{ product.title }}</a>
                    </h3>
                    
                    {%- if product.description != blank -%}
                      <p class="product-description">{{ product.description | strip_html | truncate: 100 }}</p>
                    {%- endif -%}
                    
                    {%- comment -%} STAR RATING {%- endcomment -%}
                    <div class="product-rating product-rating-large">
                      {%- assign rating = block.settings.rating | default: 5 -%}
                      {%- for i in (1..5) -%}
                        {%- if i <= rating -%}
                          <i class="ti ti-star-filled"></i>
                        {%- else -%}
                          <i class="ti ti-star"></i>
                        {%- endif -%}
                      {%- endfor -%}
                      <span class="rating-count">({{ block.settings.review_count | default: 0 }} reviews)</span>
                    </div>

                    <div class="product-price product-price-large">
                      {%- if product.compare_at_price > product.price -%}
                        <span class="price-compare">{{ product.compare_at_price | money }}</span>
                      {%- endif -%}
                      <span class="price-current">{{ product.price | money }}</span>
                    </div>

                    {%- comment -%} VARIANT COUNT {%- endcomment -%}
                    {%- if product.variants.size > 1 -%}
                      <div class="variant-info">
                        <i class="ti ti-palette"></i>
                        <span>{{ product.variants.size }} {{ product.variants.size | pluralize: 'option', 'options' }} available</span>
                      </div>
                    {%- endif -%}

                    {%- comment -%} Upload Widget Area (Global OR Block level) {%- endcomment -%}
                    {%- assign show_upload_main = false -%}
                    {%- if section.settings.enable_upload_mode_global or block.settings.enable_upload_mode -%}
                      {%- assign show_upload_main = true -%}
                    {%- endif -%}
                    
                    {% if show_upload_main %}
                      <div class="upload-widget-area">
                        {% render 'dtf-quick-upload-btn', product: product, button_text: 'Upload Design' %}
                      </div>
                    {% endif %}

                    {%- comment -%} Actions (Hidden when upload mode is enabled) {%- endcomment -%}
                    {% unless show_upload_main %}
                    {%- assign main_btn_action = block.settings.button_action | default: 'default' -%}
                    {%- if main_btn_action == 'default' -%}
                      {%- assign main_btn_action = section.settings.button_action_global | default: 'add_to_cart' -%}
                    {%- endif -%}
                    
                    <div class="main-card-actions">
                      {% if main_btn_action == 'go_to_product' %}
                        <a href="{{ product.url }}" class="sb-btn btn-view-full">
                          <i class="ti ti-arrow-right"></i>
                          <span>View Product</span>
                        </a>
                      {% else %}
                        <a href="{{ product.url }}" class="btn-view-details">
                          <i class="ti ti-eye"></i>
                          <span>View Details</span>
                        </a>
                        <form method="post" action="{{ routes.cart_add_url }}" class="quick-add-form-main">
                          <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}">
                          <input type="hidden" name="quantity" value="1">
                          <button type="submit" class="sb-btn{% unless product.available %} sb-sold-out{% endunless %}" {% unless product.available %}disabled{% endunless %}>
                            <i class="ti ti-shopping-cart-plus"></i>
                            <span>{% if product.available %}Add to Cart{% else %}Sold Out{% endif %}</span>
                          </button>
                        </form>
                      {% endif %}
                    </div>
                    {% endunless %}
                  </div>
                  
                  {%- if block.settings.enable_4d -%}
                    <div class="card-4d-effect card-4d-effect-large">
                      <div class="effect-glow"></div>
                      <div class="effect-particles">
                        {%- for i in (1..12) -%}
                          <span class="mini-particle p-{{ i }}"></span>
                        {%- endfor -%}
                      </div>
                    </div>
                  {%- endif -%}
                </div>
              {%- endif -%}
            {%- endif -%}
          {%- endfor -%}
        </div>
        
      </div>
    </div>

  </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const section = document.getElementById('showcase-{{ section.id }}');
  if (!section) return;

  // 4D Card Effects
  const cards4D = section.querySelectorAll('[data-4d="true"]');
  
  cards4D.forEach(card => {
    card.addEventListener('mousemove', function(e) {
      const rect = card.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      const centerX = rect.width / 2;
      const centerY = rect.height / 2;
      
      const rotateX = (y - centerY) / 15;
      const rotateY = (centerX - x) / 15;
      
      card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
      
      // Move shine effect
      const shine = card.querySelector('.image-shine');
      if (shine) {
        shine.style.background = `radial-gradient(circle at ${x}px ${y}px, rgba(255,255,255,0.3) 0%, transparent 50%)`;
      }
      
      // Glow effect position
      const glow = card.querySelector('.effect-glow');
      if (glow) {
        glow.style.left = x + 'px';
        glow.style.top = y + 'px';
      }
    });
    
    card.addEventListener('mouseleave', function() {
      card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale(1)';
      const shine = card.querySelector('.image-shine');
      if (shine) {
        shine.style.background = 'transparent';
      }
    });
  });

  // Quick Add to Cart AJAX
  const quickAddForms = section.querySelectorAll('.quick-add-form, .quick-add-form-main');
  
  quickAddForms.forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      
      const button = form.querySelector('button[type="submit"]');
      const originalHTML = button.innerHTML;
      button.innerHTML = '<i class="ti ti-loader ti-spin"></i>';
      button.disabled = true;
      
      const formData = new FormData(form);
      
      fetch('/cart/add.js', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        button.innerHTML = '<i class="ti ti-check"></i>';
        button.classList.add('added');
        
        setTimeout(() => {
          button.innerHTML = originalHTML;
          button.classList.remove('added');
          button.disabled = false;
        }, 2000);
        
        // Update cart count
        fetch('/cart.js')
          .then(r => r.json())
          .then(cart => {
            const cartCount = document.querySelector('.cart-count, .header-cart-count');
            if (cartCount) {
              cartCount.textContent = cart.item_count;
              cartCount.classList.add('bump');
              setTimeout(() => cartCount.classList.remove('bump'), 300);
            }
          });
      })
      .catch(error => {
        console.error('Error:', error);
        button.innerHTML = originalHTML;
        button.disabled = false;
      });
    });
  });

  // Particle Animation Enhancement
  const particles = section.querySelectorAll('.mini-particle');
  particles.forEach((particle, index) => {
    particle.style.animationDelay = (index * 0.2) + 's';
  });
});
</script>

{% schema %}
{
  "name": "Product Showcase 4D",
  "tag": "section",
  "class": "product-showcase-4d-section",
  "settings": [
    {
      "type": "text",
      "id": "header_text",
      "label": "Header Text (Gold Foil)",
      "default": "SPECIAL OFFERS"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Handpicked products just for you"
    },
    {
      "type": "header",
      "content": "Button Settings (Global)"
    },
    {
      "type": "paragraph",
      "content": "⚠️ These settings only work when 'Enable Upload Mode' is OFF"
    },
    {
      "type": "select",
      "id": "button_action_global",
      "label": "Button Action (All Cards)",
      "options": [
        { "value": "add_to_cart", "label": "Add to Cart" },
        { "value": "go_to_product", "label": "Go to Product Page" }
      ],
      "default": "add_to_cart"
    },
    {
      "type": "header",
      "content": "Upload Settings (Global)"
    },
    {
      "type": "checkbox",
      "id": "enable_upload_mode_global",
      "label": "Enable Upload Mode (All Cards)",
      "default": false,
      "info": "When enabled, shows Upload button and hides Add to Cart for ALL cards"
    },
    {
      "type": "header",
      "content": "⚙️ Gelişmiş"
    },
    {
      "type": "textarea",
      "id": "custom_css",
      "label": "Özel CSS",
      "info": "Bu section için özel CSS kodları ekleyin"
    }
  ],
  "blocks": [
    {
      "type": "left_product",
      "name": "Left Product",
      "limit": 4,
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Select Product"
        },
        {
          "type": "checkbox",
          "id": "enable_4d",
          "label": "Enable 4D Effect",
          "default": true
        },
        {
          "type": "text",
          "id": "badge_text",
          "label": "4D Badge Text",
          "default": "4D"
        },
        {
          "type": "color",
          "id": "badge_color",
          "label": "Badge Color",
          "default": "#7367f0"
        },
        {
          "type": "range",
          "id": "rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "label": "Star Rating",
          "default": 5
        },
        {
          "type": "number",
          "id": "review_count",
          "label": "Review Count",
          "default": 42
        },
        {
          "type": "header",
          "content": "Upload Settings"
        },
        {
          "type": "checkbox",
          "id": "enable_upload_mode",
          "label": "Enable Upload Mode",
          "default": false,
          "info": "When enabled, shows Upload button and hides Add to Cart"
        },
        {
          "type": "textarea",
          "id": "custom_css",
          "label": "Özel CSS (Block)",
          "info": "Bu block için özel CSS"
        }
      ]
    },
    {
      "type": "main_product",
      "name": "Main Product (Right)",
      "limit": 1,
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Select Main Product"
        },
        {
          "type": "checkbox",
          "id": "enable_4d",
          "label": "Enable 4D Effect",
          "default": true
        },
        {
          "type": "text",
          "id": "badge_text",
          "label": "4D Badge Text",
          "default": "4D PREMIUM"
        },
        {
          "type": "color",
          "id": "badge_color",
          "label": "Badge Color",
          "default": "#28c76f"
        },
        {
          "type": "range",
          "id": "rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "label": "Star Rating",
          "default": 5
        },
        {
          "type": "number",
          "id": "review_count",
          "label": "Review Count",
          "default": 128
        },
        {
          "type": "header",
          "content": "Button Settings"
        },
        {
          "type": "select",
          "id": "button_action",
          "label": "Button Action",
          "options": [
            { "value": "default", "label": "Use Global Setting" },
            { "value": "add_to_cart", "label": "Add to Cart" },
            { "value": "go_to_product", "label": "Go to Product Page" }
          ],
          "default": "default"
        },
        {
          "type": "header",
          "content": "Upload Settings"
        },
        {
          "type": "checkbox",
          "id": "enable_upload_mode",
          "label": "Enable Upload Mode",
          "default": false,
          "info": "When enabled, shows Upload button and hides Add to Cart"
        },
        {
          "type": "textarea",
          "id": "custom_css",
          "label": "Özel CSS (Block)",
          "info": "Bu block için özel CSS"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Showcase 4D",
      "category": "Products",
      "blocks": [
        { "type": "left_product" },
        { "type": "left_product" },
        { "type": "left_product" },
        { "type": "left_product" },
        { "type": "main_product" }
      ]
    }
  ]
}
{% endschema %}
