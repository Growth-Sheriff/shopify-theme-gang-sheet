{% comment %}
  Hero 3D Section - Fully Dynamic
  All elements customizable via Theme Editor
{% endcomment %}

<section class="cp-hero" id="hero" style="{% if section.settings.section_bg %}background: {{ section.settings.section_bg }};{% endif %}">
  <div class="container">
    <div class="cp-hero-grid">
      <!-- Left: Content -->
      <div class="cp-hero-content">
        <h1>
          {{ section.settings.title_line1 }}
          <span>{{ section.settings.title_line2 }}</span>
        </h1>
        
        <p class="cp-hero-subtitle">{{ section.settings.subtitle }}</p>

        <!-- Stats Row -->
        <div class="cp-hero-stats">
          {% for block in section.blocks %}
            {% if block.type == 'stat' %}
              <div class="cp-hero-stat" {{ block.shopify_attributes }}>
                <div class="cp-hero-stat-value">{{ block.settings.value }}</div>
                <div class="cp-hero-stat-label">{{ block.settings.label }}</div>
              </div>
            {% endif %}
          {% endfor %}
        </div>
        
        <div class="cp-hero-buttons">
          {% if section.settings.button1_text != blank %}
            <a href="{{ section.settings.button1_link }}" class="cp-btn cp-btn-primary">
              <i class="{{ section.settings.button1_icon }}"></i>
              {{ section.settings.button1_text }}
            </a>
          {% endif %}
          {% if section.settings.button2_text != blank %}
            <a href="{{ section.settings.button2_link }}" class="cp-btn cp-btn-outline">
              {{ section.settings.button2_text }}
            </a>
          {% endif %}
        </div>
      </div>

      <!-- Right: 3D Canvas -->
      {% if section.settings.show_3d_preview %}
      <div class="cp-3d-wrapper">
        {% if section.settings.tshirt_link != blank %}
        <a href="{{ section.settings.tshirt_link }}" class="cp-3d-link-overlay" title="View Product"></a>
        {% endif %}
        
        <div class="cp-3d-label">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 19l-7-7 7-7M19 12H5"/>
          </svg>
          {{ section.settings.preview_label }}
        </div>
        
        <!-- Color Picker Panel -->
        <div class="cp-customizer-panel">
          {% for block in section.blocks %}
            {% if block.type == 'color' %}
              <button class="cp-color-btn {% if forloop.first %}active{% endif %}" 
                      style="background: {{ block.settings.color }};{% if block.settings.color == '#ffffff' %} border: 1px solid #eee;{% endif %}" 
                      data-color="{{ block.settings.color }}" 
                      title="{{ block.settings.name }}"
                      {{ block.shopify_attributes }}></button>
            {% endif %}
          {% endfor %}
        </div>
        
        <div class="cp-3d-container">
          <canvas id="hero3DCanvas" class="cp-3d-canvas"></canvas>
          
          <button class="cp-download-btn" id="downloadBtn" title="{{ section.settings.download_btn_text }}">
            <i class="fa-solid fa-download"></i>
          </button>

          <div class="cp-3d-controls">
            <button class="cp-3d-control-btn" id="rotateLeftBtn" title="{{ section.settings.rotate_left_text }}">
              <i class="fa-solid fa-rotate-left"></i>
            </button>
            <button class="cp-3d-control-btn" id="resetViewBtn" title="{{ section.settings.reset_view_text }}">
              <i class="fa-solid fa-arrows-rotate"></i>
            </button>
            <button class="cp-3d-control-btn" id="rotateRightBtn" title="{{ section.settings.rotate_right_text }}">
              <i class="fa-solid fa-rotate-right"></i>
            </button>
            <button class="cp-upload-btn" id="uploadTrigger" title="{{ section.settings.upload_btn_text }}">
              <i class="fa-solid fa-image"></i>
            </button>
            <input type="file" id="logoInput" accept="image/*" style="display: none;">
          </div>
          
          <!-- Loading Indicator -->
          <div class="cp-3d-loading" id="loading3D">
            <div class="cp-loading-spinner"></div>
            <span>Loading 3D...</span>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
  
  <!-- Three.js CDN -->
  {% if section.settings.show_3d_preview %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  
  <script>
    window.shirtModelUrl = '{{ "shirt_baked.glb" | asset_url }}';
    
    (function() {
      const canvas = document.getElementById('hero3DCanvas');
      const loadingEl = document.getElementById('loading3D');
      if (!canvas || !window.shirtModelUrl) return;
      
      // Scene setup
      const scene = new THREE.Scene();
      scene.background = null; // Transparent
      
      // Camera
      const camera = new THREE.PerspectiveCamera(45, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
      camera.position.set(0, 0, 3);
      
      // Renderer
      const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
      renderer.setSize(canvas.clientWidth, canvas.clientHeight);
      renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
      renderer.outputEncoding = THREE.sRGBEncoding;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.2;
      
      // Lights
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
      scene.add(ambientLight);
      
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
      directionalLight.position.set(5, 10, 7);
      scene.add(directionalLight);
      
      const fillLight = new THREE.DirectionalLight(0xffffff, 0.3);
      fillLight.position.set(-5, 0, -5);
      scene.add(fillLight);
      
      // Orbit Controls
      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;
      controls.enableZoom = true;
      controls.minDistance = 1.5;
      controls.maxDistance = 6;
      controls.enablePan = false;
      controls.autoRotate = true;
      controls.autoRotateSpeed = 1;
      
      let shirtMesh = null;
      let currentColor = '#7dd3fc';
      
      // Load Model
      const loader = new THREE.GLTFLoader();
      loader.load(
        window.shirtModelUrl,
        function(gltf) {
          const model = gltf.scene;
          
          // Find shirt mesh and apply material
          model.traverse(function(child) {
            if (child.isMesh) {
              shirtMesh = child;
              child.material = new THREE.MeshStandardMaterial({
                color: new THREE.Color(currentColor),
                roughness: 0.6,
                metalness: 0.1
              });
            }
          });
          
          // Center and scale model
          const box = new THREE.Box3().setFromObject(model);
          const center = box.getCenter(new THREE.Vector3());
          const size = box.getSize(new THREE.Vector3());
          const maxDim = Math.max(size.x, size.y, size.z);
          const scale = 2 / maxDim;
          model.scale.setScalar(scale);
          model.position.sub(center.multiplyScalar(scale));
          
          scene.add(model);
          
          // Hide loading
          if (loadingEl) loadingEl.style.display = 'none';
        },
        function(xhr) {
          // Progress
          const percent = (xhr.loaded / xhr.total * 100).toFixed(0);
          if (loadingEl) loadingEl.querySelector('span').textContent = `Loading ${percent}%`;
        },
        function(error) {
          console.error('Error loading model:', error);
          if (loadingEl) loadingEl.innerHTML = '<span style="color:#ea5455">Failed to load 3D model</span>';
        }
      );
      
      // Color change function
      window.changeTshirtColor = function(color) {
        currentColor = color;
        if (shirtMesh && shirtMesh.material) {
          shirtMesh.material.color.set(color);
        }
      };
      
      // Rotate functions
      window.rotateTshirt = function(dir) {
        controls.autoRotate = false;
        if (shirtMesh) {
          shirtMesh.parent.rotation.y += dir * 0.5;
        }
      };
      
      window.resetView = function() {
        camera.position.set(0, 0, 3);
        controls.reset();
        controls.autoRotate = true;
      };
      
      window.stopAutoRotate = function() {
        controls.autoRotate = false;
      };
      
      // Download function
      window.downloadDesign = function() {
        renderer.render(scene, camera);
        const link = document.createElement('a');
        link.download = 'tshirt-design.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
      };
      
      // Animation loop
      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      animate();
      
      // Resize handler
      function onResize() {
        const width = canvas.clientWidth;
        const height = canvas.clientHeight;
        camera.aspect = width / height;
        camera.updateProjectionMatrix();
        renderer.setSize(width, height);
      }
      window.addEventListener('resize', onResize);
      
      // Initial resize
      setTimeout(onResize, 100);
    })();
  </script>
  {% endif %}
</section>

{% schema %}
{
  "name": "Hero 3D Section",
  "tag": "section",
  "class": "homepage-hero",
  "settings": [
    {
      "type": "header",
      "content": "3D Preview Toggle"
    },
    {
      "type": "checkbox",
      "id": "show_3d_preview",
      "label": "Show 3D T-Shirt Preview",
      "default": true
    },
    {
      "type": "url",
      "id": "tshirt_link",
      "label": "3D T-Shirt Click Link",
      "info": "Where to go when user clicks on the 3D t-shirt"
    },
    {
      "type": "header",
      "content": "Section Background"
    },
    {
      "type": "color_background",
      "id": "section_bg",
      "label": "Background",
      "default": "transparent"
    },
    {
      "type": "header",
      "content": "Title"
    },
    {
      "type": "text",
      "id": "title_line1",
      "label": "Title Line 1",
      "default": "Design Custom,"
    },
    {
      "type": "text",
      "id": "title_line2",
      "label": "Title Line 2 (Gradient)",
      "default": "High-Quality DTF Transfers"
    },
    {
      "type": "textarea",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Production-ready & easy to use custom printing solution for Reliability and Customizability. See your design in real-time 3D."
    },
    {
      "type": "header",
      "content": "Buttons"
    },
    {
      "type": "text",
      "id": "button1_text",
      "label": "Button 1 Text",
      "default": "Start Designing"
    },
    {
      "type": "url",
      "id": "button1_link",
      "label": "Button 1 Link"
    },
    {
      "type": "text",
      "id": "button1_icon",
      "label": "Button 1 Icon Class",
      "default": "fa-solid fa-cart-plus"
    },
    {
      "type": "text",
      "id": "button2_text",
      "label": "Button 2 Text",
      "default": "View Products"
    },
    {
      "type": "url",
      "id": "button2_link",
      "label": "Button 2 Link"
    },
    {
      "type": "header",
      "content": "3D Preview"
    },
    {
      "type": "text",
      "id": "preview_label",
      "label": "Preview Label",
      "default": "3D Preview"
    },
    {
      "type": "header",
      "content": "3D Control Buttons"
    },
    {
      "type": "text",
      "id": "download_btn_text",
      "label": "Download Button Tooltip",
      "default": "Download Design"
    },
    {
      "type": "text",
      "id": "rotate_left_text",
      "label": "Rotate Left Tooltip",
      "default": "Rotate Left"
    },
    {
      "type": "text",
      "id": "reset_view_text",
      "label": "Reset View Tooltip",
      "default": "Reset View"
    },
    {
      "type": "text",
      "id": "rotate_right_text",
      "label": "Rotate Right Tooltip",
      "default": "Rotate Right"
    },
    {
      "type": "text",
      "id": "upload_btn_text",
      "label": "Upload Button Tooltip",
      "default": "Upload Logo"
    }
  ],
  "blocks": [
    {
      "type": "stat",
      "name": "Statistic",
      "settings": [
        {
          "type": "text",
          "id": "value",
          "label": "Value",
          "default": "10M+"
        },
        {
          "type": "text",
          "id": "label",
          "label": "Label",
          "default": "End Users"
        }
      ]
    },
    {
      "type": "color",
      "name": "T-Shirt Color",
      "settings": [
        {
          "type": "color",
          "id": "color",
          "label": "Color",
          "default": "#7dd3fc"
        },
        {
          "type": "text",
          "id": "name",
          "label": "Color Name",
          "default": "Light Blue"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Hero 3D Section",
      "blocks": [
        { "type": "stat", "settings": { "value": "10M+", "label": "End Users" } },
        { "type": "stat", "settings": { "value": "20K+", "label": "Trust CloudyPrints" } },
        { "type": "stat", "settings": { "value": "5,000+", "label": "Resolved Tickets" } },
        { "type": "stat", "settings": { "value": "600+", "label": "5 ‚≠ê Reviews" } },
        { "type": "color", "settings": { "color": "#7dd3fc", "name": "Light Blue" } },
        { "type": "color", "settings": { "color": "#3b82f6", "name": "Blue" } },
        { "type": "color", "settings": { "color": "#ffffff", "name": "White" } },
        { "type": "color", "settings": { "color": "#1a1a1a", "name": "Black" } },
        { "type": "color", "settings": { "color": "#ef4444", "name": "Red" } },
        { "type": "color", "settings": { "color": "#22c55e", "name": "Green" } },
        { "type": "color", "settings": { "color": "#f59e0b", "name": "Orange" } },
        { "type": "color", "settings": { "color": "#ec4899", "name": "Pink" } }
      ]
    }
  ]
}
{% endschema %}
