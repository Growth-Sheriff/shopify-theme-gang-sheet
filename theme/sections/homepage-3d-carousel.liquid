{% comment %}
  3D Product Carousel - Product Bar Style + 4D Effects + Block-based Products + Banner Slider
  Features: 4D hover effects, gold foil header, individual product blocks, banner slider, My Device upload, Add to Cart
{% endcomment %}

{%- render 'custom-css-renderer', section: section -%}

{{ 'homepage-3d-carousel.css' | asset_url | stylesheet_tag }}

<section class="carousel-3d-section" id="carousel3d-{{ section.id }}">
  
  <!-- Banner Slider (NEW!) -->
  {% if section.settings.show_banners %}
  <div class="banner-slider-wrapper">
    <div class="banner-slider" id="bannerSlider-{{ section.id }}">
      {% for block in section.blocks %}
        {% if block.type == 'banner' %}
        <div class="banner-slide{% if forloop.first %} active{% endif %}" data-index="{{ forloop.index0 }}" {{ block.shopify_attributes }}>
          <div class="banner-content" style="
            background-color: {{ block.settings.bg_color | default: '#7367f0' }};
          ">
            <!-- Desktop Background -->
            {% if block.settings.bg_image != blank %}
            <picture class="banner-bg-picture">
              {% if block.settings.bg_image_mobile != blank %}
              <source media="(max-width: 767px)" srcset="{{ block.settings.bg_image_mobile | image_url: width: 800 }}">
              {% endif %}
              <img 
                src="{{ block.settings.bg_image | image_url: width: 1920 }}" 
                alt="{{ block.settings.heading | default: 'Banner' }}"
                class="banner-bg-img banner-bg-img--{{ block.settings.image_fit | default: 'cover' }}"
                loading="lazy"
              >
            </picture>
            {% endif %}
            
            <div class="banner-overlay" style="background: {{ block.settings.overlay_color | default: 'rgba(0,0,0,0.3)' }};"></div>
            
            {% comment %} Sadece i√ßerik varsa banner-text g√∂ster {% endcomment %}
            {% assign has_banner_content = false %}
            {% if block.settings.badge_text != blank or block.settings.heading != blank or block.settings.subheading != blank or block.settings.button_text != blank %}
              {% assign has_banner_content = true %}
            {% endif %}
            
            {% if has_banner_content %}
            <div class="banner-text" style="color: {{ block.settings.text_color | default: '#ffffff' }}; text-align: {{ block.settings.text_align | default: 'center' }}; {% if block.settings.text_align == 'left' %}align-items: flex-start;{% elsif block.settings.text_align == 'right' %}align-items: flex-end;{% endif %}">
              {% if block.settings.badge_text != blank %}
              <span class="banner-badge">{{ block.settings.badge_text }}</span>
              {% endif %}
              {% if block.settings.heading != blank %}
              <h2 class="banner-heading">{{ block.settings.heading }}</h2>
              {% endif %}
              {% if block.settings.subheading != blank %}
              <p class="banner-subheading">{{ block.settings.subheading }}</p>
              {% endif %}
              {% if block.settings.button_text != blank %}
              <a href="{{ block.settings.button_link }}" class="banner-btn" style="background: {{ block.settings.button_bg | default: '#ffffff' }}; color: {{ block.settings.button_color | default: '#7367f0' }};">
                {{ block.settings.button_text }}
                <i class="fa-solid fa-arrow-right"></i>
              </a>
              {% endif %}
            </div>
            {% endif %}
          </div>
        </div>
        {% endif %}
      {% endfor %}
    </div>
    
    <!-- Banner Navigation -->
    <button class="banner-nav banner-prev" aria-label="Previous Banner">
      <i class="fa-solid fa-chevron-left"></i>
    </button>
    <button class="banner-nav banner-next" aria-label="Next Banner">
      <i class="fa-solid fa-chevron-right"></i>
    </button>
    
    <!-- Banner Dots -->
    <div class="banner-dots" id="bannerDots-{{ section.id }}"></div>
  </div>
  {% endif %}

  <!-- 4D Gold Foil Header -->
  {% if section.settings.show_header %}
  <div class="section-header-4d">
    <div class="header-deco-wrap">
      {%- comment -%} Left Side Decorative Line {%- endcomment -%}
      <div class="header-side-deco side-left">
        <span class="deco-diamond"></span>
        <span class="deco-line"></span>
        <span class="deco-dot"></span>
      </div>
      
      <div class="header-4d-container">
        {%- comment -%} Corner Accents {%- endcomment -%}
        <span class="gold-corner corner-tl"></span>
        <span class="gold-corner corner-tr"></span>
        <span class="gold-corner corner-bl"></span>
        <span class="gold-corner corner-br"></span>
        
        <div class="header-sparkles">
          {% for i in (1..20) %}
            <div class="sparkle" style="--delay: {{ i | times: 0.15 }}s; --x: {{ i | times: 5 }}%;"></div>
          {% endfor %}
        </div>
        <div class="header-4d-inner">
          <span class="header-tag">{{ section.settings.header_tag | default: '‚ú® LIMITED TIME' }}</span>
          <h2 class="header-title-4d">{{ section.settings.title | default: 'BLACK FRIDAY' }}</h2>
          <p class="header-subtitle">{{ section.settings.subtitle | default: 'Exclusive deals on premium products' }}</p>
        </div>
      </div>
      
      {%- comment -%} Right Side Decorative Line {%- endcomment -%}
      <div class="header-side-deco side-right">
        <span class="deco-dot"></span>
        <span class="deco-line"></span>
        <span class="deco-diamond"></span>
      </div>
    </div>
  </div>
  {% endif %}

  {% if section.settings.show_carousel %}
  <div class="container">
    <!-- 3D Carousel -->
    <div class="carousel-3d-wrapper">
      <div class="carousel-3d" id="carousel3d-inner-{{ section.id }}">
        {% for block in section.blocks %}
          {% if block.type == 'product' %}
            {% assign product = block.settings.product %}
            <div class="carousel-3d-item" data-index="{{ forloop.index0 }}" {{ block.shopify_attributes }}>
              <div class="product-card-4d" data-product-id="{{ product.id }}">
                <!-- 4D Layers -->
                <div class="card-4d-layers">
                  <div class="layer layer-1"></div>
                  <div class="layer layer-2"></div>
                  <div class="layer layer-3"></div>
                </div>
                
                <div class="card-inner">
                  <!-- Badges -->
                  <div class="card-badges">
                    {% if block.settings.show_4d_badge %}
                      <span class="badge badge-4d">
                        <span class="badge-4d-text">4D</span>
                      </span>
                    {% endif %}
                    {% if product.compare_at_price > product.price %}
                      {% assign discount = product.compare_at_price | minus: product.price | times: 100.0 | divided_by: product.compare_at_price | round %}
                      <span class="badge badge-discount">{{ discount }}% OFF</span>
                    {% endif %}
                    {% if block.settings.custom_badge != blank %}
                      <span class="badge badge-custom" style="background: {{ block.settings.badge_color }};">{{ block.settings.custom_badge }}</span>
                    {% endif %}
                  </div>
                  
                  <!-- Wishlist -->
                  <button class="wishlist-btn" aria-label="Add to wishlist"
                    data-product-id="{{ product.id }}"
                    data-product-handle="{{ product.handle }}"
                    data-product-title="{{ product.title | escape }}"
                    data-product-image="{{ product.featured_image | image_url: width: 300 }}"
                    data-product-price="{{ product.price | money }}"
                    data-product-compare-price="{{ product.compare_at_price | money }}">
                    <i class="fa-regular fa-heart"></i>
                  </button>
                  
                  <!-- Product Image with 4D Effect -->
                  <div class="product-image-4d">
                    <div class="image-4d-container">
                      {% if product.featured_image %}
                        <img src="{{ product.featured_image | image_url: width: 500 }}" 
                             alt="{{ product.title }}"
                             width="500" height="500"
                             loading="lazy"
                             class="product-img">
                      {% else %}
                        <div class="placeholder-img">
                          <i class="fa-solid fa-image"></i>
                        </div>
                      {% endif %}
                      
                      <!-- 4D Floating Elements -->
                      <div class="floating-elements">
                        <div class="float-circle float-1"></div>
                        <div class="float-circle float-2"></div>
                        <div class="float-circle float-3"></div>
                      </div>
                      
                      <!-- Glow Effect -->
                      <div class="image-glow"></div>
                    </div>
                    
                    <!-- Perfect For Label -->
                    {% if block.settings.perfect_for != blank %}
                      <div class="perfect-for-label">
                        <span>Perfect for:</span>
                        <strong>{{ block.settings.perfect_for }}</strong>
                      </div>
                    {% endif %}
                  </div>
                  
                  <!-- Product Info -->
                  <div class="product-info">
                    {% if product.vendor %}
                      <span class="product-vendor">{{ product.vendor }}</span>
                    {% endif %}
                    
                    <h3 class="product-title">{{ product.title | default: 'Product Title' | truncate: 50 }}</h3>
                    
                    <!-- Rating -->
                    <div class="product-rating">
                      {% assign rating = block.settings.rating | default: 5 %}
                      <div class="stars">
                        {% for i in (1..5) %}
                          {% if i <= rating %}
                            <i class="fa-solid fa-star"></i>
                          {% else %}
                            <i class="fa-regular fa-star"></i>
                          {% endif %}
                        {% endfor %}
                      </div>
                      <span class="rating-count">({{ block.settings.review_count | default: 0 }})</span>
                    </div>
                    
                    <!-- Price -->
                    <div class="product-price">
                      {% if product.compare_at_price > product.price %}
                        <span class="compare-price">{{ product.compare_at_price | money }}</span>
                      {% endif %}
                      <span class="current-price">{{ product.price | money }}</span>
                    </div>
                    
                    <!-- Upload Widget Area - Merkezi Sistem -->
                    {%- liquid
                      assign show_upload_carousel = false
                      if settings.upload_mode_enabled and product != blank
                        assign check_handle = product.handle
                        if settings.upload_mode_product_1.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_2.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_3.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_4.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_5.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_6.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_7.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_8.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_9.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_10.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_11.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_12.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_13.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_14.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_15.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_16.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_17.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_18.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_19.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_20.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_21.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_22.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_23.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_24.handle == check_handle
                          assign show_upload_carousel = true
                        elsif settings.upload_mode_product_25.handle == check_handle
                          assign show_upload_carousel = true
                        endif
                      endif
                    -%}
                    
                    {% if show_upload_carousel %}
                      <div class="upload-widget-area">
                        {% render 'dtf-quick-upload-btn', product: product, button_text: settings.upload_button_text | default: 'Upload Design' %}
                      </div>
                    {% endif %}
                    
                    <!-- Product Action Button (Add to Cart or Go to Product) -->
                    {% unless show_upload_carousel %}
                    <div class="product-actions">
                      {% if block.settings.button_action == 'go_to_product' or product.variants.size > 1 %}
                        {%- comment -%} Go to product page if has variants or setting says so {%- endcomment -%}
                        <a href="{{ product.url }}" class="sb-btn view-product-btn">
                          <i class="fa-solid fa-{% if product.variants.size > 1 %}eye{% else %}arrow-right{% endif %}"></i>
                          <span>{% if product.variants.size > 1 %}View Options{% else %}{{ block.settings.button_text | default: 'View Product' }}{% endif %}</span>
                        </a>
                      {% else %}
                        {% if product.available %}
                          <button class="sb-btn add-to-cart-btn" data-variant-id="{{ product.first_available_variant.id }}">
                            <i class="fa-solid fa-cart-plus"></i>
                            <span>{{ block.settings.button_text | default: 'Add to Cart' }}</span>
                          </button>
                        {% else %}
                          <button class="sb-btn sb-sold-out" disabled>
                            <span>Sold Out</span>
                          </button>
                        {% endif %}
                      {% endif %}
                    </div>
                    {% endunless %}
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
        
        {% if section.blocks.size == 0 %}
          <!-- Demo Products when no blocks -->
          {% for i in (1..5) %}
            <div class="carousel-3d-item" data-index="{{ forloop.index0 }}">
              <div class="product-card-4d">
                <div class="card-4d-layers">
                  <div class="layer layer-1"></div>
                  <div class="layer layer-2"></div>
                  <div class="layer layer-3"></div>
                </div>
                <div class="card-inner">
                  <div class="card-badges">
                    <span class="badge badge-4d"><span class="badge-4d-text">4D</span></span>
                    <span class="badge badge-discount">20% OFF</span>
                  </div>
                  <button class="wishlist-btn"><i class="fa-regular fa-heart"></i></button>
                  <div class="product-image-4d">
                    <div class="image-4d-container">
                      <div class="placeholder-img"><i class="fa-solid fa-image"></i></div>
                      <div class="floating-elements">
                        <div class="float-circle float-1"></div>
                        <div class="float-circle float-2"></div>
                      </div>
                      <div class="image-glow"></div>
                    </div>
                  </div>
                  <div class="product-info">
                    <span class="product-vendor">Brand Name</span>
                    <h3 class="product-title">Sample Product {{ i }}</h3>
                    <div class="product-rating">
                      <div class="stars">
                        <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
                        <i class="fa-solid fa-star"></i><i class="fa-solid fa-star"></i>
                        <i class="fa-solid fa-star-half-stroke"></i>
                      </div>
                      <span class="rating-count">(128)</span>
                    </div>
                    <div class="product-price">
                      <span class="compare-price">$9.99</span>
                      <span class="current-price">$4.99</span>
                    </div>
                    <div class="upload-area">
                      <button class="upload-btn"><i class="fa-solid fa-rotate"></i><span>My Device</span></button>
                    </div>
                    <div class="product-actions">
                      <button class="sb-btn add-to-cart-btn"><i class="fa-solid fa-cart-plus sb-icon"></i><span class="sb-text">Add to Cart</span></button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endfor %}
        {% endif %}
      </div>
      
      <!-- Navigation -->
      <button class="carousel-nav carousel-prev" aria-label="Previous">
        <i class="fa-solid fa-chevron-left"></i>
      </button>
      <button class="carousel-nav carousel-next" aria-label="Next">
        <i class="fa-solid fa-chevron-right"></i>
      </button>
      
      <!-- Dots -->
      <div class="carousel-dots"></div>
    </div>
  </div>
  {% endif %}
  
  <!-- Ambient Particles -->
  <div class="ambient-particles"></div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const section = document.getElementById('carousel3d-{{ section.id }}');
  if (!section) return;
  
  // ========== BANNER SLIDER ==========
  const bannerSlider = section.querySelector('.banner-slider');
  if (bannerSlider) {
    const bannerSlides = bannerSlider.querySelectorAll('.banner-slide');
    const bannerDotsContainer = section.querySelector('.banner-dots');
    const bannerPrevBtn = section.querySelector('.banner-prev');
    const bannerNextBtn = section.querySelector('.banner-next');
    
    if (bannerSlides.length > 0) {
      let currentBanner = 0;
      const totalBanners = bannerSlides.length;
      
      // Create dots
      bannerSlides.forEach((_, i) => {
        const dot = document.createElement('button');
        dot.className = 'banner-dot' + (i === 0 ? ' active' : '');
        dot.addEventListener('click', () => goToBanner(i));
        bannerDotsContainer.appendChild(dot);
      });
      
      const bannerDots = bannerDotsContainer.querySelectorAll('.banner-dot');
      
      function updateBanner() {
        bannerSlides.forEach((slide, i) => {
          slide.classList.toggle('active', i === currentBanner);
          slide.style.transform = `translateX(${(i - currentBanner) * 100}%)`;
        });
        bannerDots.forEach((dot, i) => dot.classList.toggle('active', i === currentBanner));
      }
      
      function goToBanner(index) {
        currentBanner = ((index % totalBanners) + totalBanners) % totalBanners;
        updateBanner();
      }
      
      bannerPrevBtn?.addEventListener('click', () => goToBanner(currentBanner - 1));
      bannerNextBtn?.addEventListener('click', () => goToBanner(currentBanner + 1));
      
      // Auto-play banners
      let bannerAutoPlay = setInterval(() => goToBanner(currentBanner + 1), 5000);
      bannerSlider.addEventListener('mouseenter', () => clearInterval(bannerAutoPlay));
      bannerSlider.addEventListener('mouseleave', () => {
        bannerAutoPlay = setInterval(() => goToBanner(currentBanner + 1), 5000);
      });
      
      // Touch swipe
      let bannerStartX = 0;
      bannerSlider.addEventListener('touchstart', e => bannerStartX = e.touches[0].clientX, {passive: true});
      bannerSlider.addEventListener('touchend', e => {
        const diff = bannerStartX - e.changedTouches[0].clientX;
        if (Math.abs(diff) > 50) diff > 0 ? goToBanner(currentBanner + 1) : goToBanner(currentBanner - 1);
      });
      
      updateBanner();
    }
  }
  
  // ========== 3D CAROUSEL ==========
  const carousel = section.querySelector('.carousel-3d');
  if (!carousel) return;
  
  const items = carousel.querySelectorAll('.carousel-3d-item');
  const dotsContainer = section.querySelector('.carousel-dots');
  const prevBtn = section.querySelector('.carousel-prev');
  const nextBtn = section.querySelector('.carousel-next');
  
  if (items.length === 0) return;
  
  // Check if mobile
  const isMobile = window.innerWidth <= 768;
  
  let currentIndex = 0;
  const totalItems = items.length;
  const radius = 400;
  const autoPlayDelay = {{ section.settings.autoplay_speed | default: 5000 }};
  let autoPlayInterval;
  
  // Skip 3D carousel logic on mobile - use CSS horizontal scroll instead
  if (isMobile) {
    // Reset all transforms for mobile
    items.forEach(item => {
      item.style.transform = 'none';
      item.style.opacity = '1';
      item.style.filter = 'none';
      item.style.zIndex = '1';
    });
    return; // Exit early - let CSS handle mobile layout
  }
  
  // Create dots (desktop only)
  items.forEach((_, i) => {
    const dot = document.createElement('button');
    dot.className = 'carousel-dot' + (i === 0 ? ' active' : '');
    dot.addEventListener('click', () => { goToSlide(i); resetAutoPlay(); });
    dotsContainer.appendChild(dot);
  });
  
  const dots = dotsContainer.querySelectorAll('.carousel-dot');
  
  function updateCarousel() {
    const angleStep = 360 / totalItems;
    items.forEach((item, i) => {
      const offset = i - currentIndex;
      let angle = offset * angleStep;
      if (angle > 180) angle -= 360;
      if (angle < -180) angle += 360;
      
      const radian = (angle * Math.PI) / 180;
      const translateX = Math.sin(radian) * radius;
      const translateZ = Math.cos(radian) * radius - radius;
      const scale = (translateZ + radius * 2) / (radius * 2.5);
      const opacity = Math.max(0.3, scale);
      
      item.style.transform = `translateX(${translateX}px) translateZ(${translateZ}px) scale(${0.6 + scale * 0.5})`;
      item.style.opacity = opacity;
      item.style.zIndex = Math.round(scale * 100);
      item.style.filter = i === currentIndex ? 'none' : `blur(${Math.abs(offset)}px)`;
      item.classList.toggle('active', i === currentIndex);
    });
    
    dots.forEach((dot, i) => dot.classList.toggle('active', i === currentIndex));
  }
  
  function goToSlide(index) {
    currentIndex = ((index % totalItems) + totalItems) % totalItems;
    updateCarousel();
  }
  
  function nextSlide() { goToSlide(currentIndex + 1); }
  function prevSlide() { goToSlide(currentIndex - 1); }
  
  prevBtn?.addEventListener('click', () => { prevSlide(); resetAutoPlay(); });
  nextBtn?.addEventListener('click', () => { nextSlide(); resetAutoPlay(); });
  
  // Touch/Drag (desktop only)
  let startX = 0, isDragging = false;
  carousel.addEventListener('mousedown', e => { isDragging = true; startX = e.clientX; });
  carousel.addEventListener('touchstart', e => { isDragging = true; startX = e.touches[0].clientX; }, {passive: true});
  document.addEventListener('mouseup', handleDragEnd);
  document.addEventListener('touchend', handleDragEnd);
  
  function handleDragEnd(e) {
    if (!isDragging) return;
    isDragging = false;
    const endX = e.type === 'touchend' ? e.changedTouches[0].clientX : e.clientX;
    const diff = startX - endX;
    if (Math.abs(diff) > 50) {
      diff > 0 ? nextSlide() : prevSlide();
    }
    resetAutoPlay();
  }
  
  // 4D Tilt Effect
  document.querySelectorAll('.product-card-4d').forEach(card => {
    card.addEventListener('mousemove', e => {
      const rect = card.getBoundingClientRect();
      const x = (e.clientX - rect.left) / rect.width - 0.5;
      const y = (e.clientY - rect.top) / rect.height - 0.5;
      
      card.style.transform = `perspective(1000px) rotateY(${x * 15}deg) rotateX(${-y * 15}deg)`;
      
      const glow = card.querySelector('.image-glow');
      if (glow) {
        glow.style.opacity = '1';
        glow.style.background = `radial-gradient(circle at ${(x + 0.5) * 100}% ${(y + 0.5) * 100}%, rgba(102, 126, 234, 0.4), transparent 60%)`;
      }
    });
    
    card.addEventListener('mouseleave', () => {
      card.style.transform = '';
      const glow = card.querySelector('.image-glow');
      if (glow) glow.style.opacity = '0';
    });
  });
  
  // Add to Cart
  section.querySelectorAll('.add-to-cart-btn').forEach(btn => {
    btn.addEventListener('click', async (e) => {
      e.preventDefault();
      const variantId = btn.dataset.variantId;
      if (!variantId) return;
      
      btn.disabled = true;
      btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
      
      try {
        const res = await fetch('/cart/add.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ id: variantId, quantity: 1 })
        });
        
        if (res.ok) {
          btn.innerHTML = '<i class="fa-solid fa-check"></i> Added!';
          btn.classList.add('success');
          const cartRes = await fetch('/cart.js');
          const cart = await cartRes.json();
          document.querySelectorAll('.cart-count, .cart-badge, #drawerCount, #navCartBadge').forEach(el => el.textContent = cart.item_count);
          
          // Open drawer cart if exists
          const drawerCart = document.getElementById('drawerCart');
          if (drawerCart && typeof window.toggleDrawerCart === 'function') {
            window.toggleDrawerCart();
          } else if (drawerCart) {
            drawerCart.classList.add('active');
            document.body.classList.add('drawer-open');
          }
          
          setTimeout(() => {
            btn.innerHTML = '<i class="fa-solid fa-cart-plus"></i><span>Add to Cart</span>';
            btn.classList.remove('success');
            btn.disabled = false;
          }, 2000);
        }
      } catch (err) {
        btn.innerHTML = '<i class="fa-solid fa-times"></i> Error';
        setTimeout(() => {
          btn.innerHTML = '<i class="fa-solid fa-cart-plus"></i><span>Add to Cart</span>';
          btn.disabled = false;
        }, 2000);
      }
    });
  });
  
  // Autoplay
  let autoPlayStopped = false;
  
  function startAutoPlay() {
    if (autoPlayStopped) return; // Don't restart if manually stopped
    if ({{ section.settings.autoplay | json }}) {
      autoPlayInterval = setInterval(nextSlide, autoPlayDelay);
    }
  }
  function stopAutoPlay() {
    clearInterval(autoPlayInterval);
    autoPlayStopped = true;
  }
  function resetAutoPlay() {
    if (autoPlayStopped) return;
    clearInterval(autoPlayInterval);
    startAutoPlay();
  }
  
  section.addEventListener('mouseenter', () => clearInterval(autoPlayInterval));
  section.addEventListener('mouseleave', startAutoPlay);
  
  // Stop autoplay when Upload Design button is clicked
  section.querySelectorAll('.upload-widget-area button, [onclick*="openUploadModal"]').forEach(btn => {
    btn.addEventListener('click', () => {
      stopAutoPlay();
    });
  });
  
  // Particles
  const particles = section.querySelector('.ambient-particles');
  for (let i = 0; i < 20; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.style.cssText = `left:${Math.random()*100}%;animation-delay:${Math.random()*10}s;animation-duration:${10+Math.random()*10}s;width:${3+Math.random()*5}px;height:${3+Math.random()*5}px;`;
    particles.appendChild(p);
  }
  
  // Init
  updateCarousel();
  startAutoPlay();
});
</script>

{% schema %}
{
  "name": "3D Carousel 4D",
  "tag": "section",
  "class": "section-3d-carousel-4d",
  "settings": [
    {
      "type": "header",
      "content": "Section Visibility"
    },
    {
      "type": "checkbox",
      "id": "show_banners",
      "label": "Show Banner Slider",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_header",
      "label": "Show 4D Header",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_carousel",
      "label": "Show Product Carousel",
      "default": true
    },
    {
      "type": "header",
      "content": "4D Header"
    },
    {
      "type": "text",
      "id": "header_tag",
      "label": "Header Tag",
      "default": "‚ú® LIMITED TIME"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Title",
      "default": "BLACK FRIDAY"
    },
    {
      "type": "text",
      "id": "subtitle",
      "label": "Subtitle",
      "default": "Exclusive deals on premium products"
    },
    {
      "type": "header",
      "content": "Carousel Settings"
    },
    {
      "type": "checkbox",
      "id": "autoplay",
      "label": "Auto-play",
      "default": true
    },
    {
      "type": "range",
      "id": "autoplay_speed",
      "min": 2000,
      "max": 8000,
      "step": 1000,
      "default": 5000,
      "unit": "ms",
      "label": "Auto-play speed"
    },
    {
      "type": "header",
      "content": "‚öôÔ∏è Geli≈ümi≈ü"
    },
    {
      "type": "textarea",
      "id": "custom_css",
      "label": "√ñzel CSS",
      "info": "Bu section i√ßin √∂zel CSS kodlarƒ± ekleyin"
    }
  ],
  "blocks": [
    {
      "type": "banner",
      "name": "Banner Slide",
      "settings": [
        {
          "type": "header",
          "content": "üì∑ G√∂rsel Ayarlarƒ±"
        },
        {
          "type": "image_picker",
          "id": "bg_image",
          "label": "Arka Plan G√∂rseli (Desktop)"
        },
        {
          "type": "image_picker",
          "id": "bg_image_mobile",
          "label": "Mobil G√∂rsel (Opsiyonel)",
          "info": "768px altƒ±nda bu g√∂rsel kullanƒ±lƒ±r"
        },
        {
          "type": "select",
          "id": "image_fit",
          "label": "G√∂rsel Uyum Modu",
          "options": [
            { "value": "cover", "label": "Kapla (Cover) - Kƒ±rpƒ±lƒ±r" },
            { "value": "contain", "label": "Sƒ±ƒüdƒ±r (Contain) - Tam g√∂r√ºn√ºr" },
            { "value": "fill", "label": "Doldur (Fill) - Esnetilir" }
          ],
          "default": "cover",
          "info": "Cover: Alanƒ± kaplar, kenarlar kƒ±rpƒ±labilir. Contain: G√∂rsel tam g√∂r√ºn√ºr. Fill: Oranƒ± bozarak doldurur."
        },
        {
          "type": "color",
          "id": "bg_color",
          "label": "Arka Plan Rengi (g√∂rsel yoksa)",
          "default": "#7367f0"
        },
        {
          "type": "header",
          "content": "üìù ƒ∞√ßerik"
        },
        {
          "type": "color_background",
          "id": "overlay_color",
          "label": "Overlay Rengi",
          "default": "linear-gradient(135deg, rgba(115, 103, 240, 0.8), rgba(102, 126, 234, 0.8))"
        },
        {
          "type": "text",
          "id": "badge_text",
          "label": "Rozet Metni",
          "default": "üî• HOT DEAL"
        },
        {
          "type": "text",
          "id": "heading",
          "label": "Ba≈ülƒ±k",
          "default": "Amazing Deals"
        },
        {
          "type": "textarea",
          "id": "subheading",
          "label": "Alt Ba≈ülƒ±k",
          "default": "Up to 50% off on all products"
        },
        {
          "type": "color",
          "id": "text_color",
          "label": "Metin Rengi",
          "default": "#ffffff"
        },
        {
          "type": "select",
          "id": "text_align",
          "label": "Metin Hizalama",
          "options": [
            { "value": "left", "label": "Sol" },
            { "value": "center", "label": "Orta" },
            { "value": "right", "label": "Saƒü" }
          ],
          "default": "center"
        },
        {
          "type": "header",
          "content": "üîò Buton"
        },
        {
          "type": "text",
          "id": "button_text",
          "label": "Buton Metni",
          "default": "Shop Now"
        },
        {
          "type": "url",
          "id": "button_link",
          "label": "Buton Linki"
        },
        {
          "type": "color",
          "id": "button_bg",
          "label": "Buton Arka Planƒ±",
          "default": "#ffffff"
        },
        {
          "type": "color",
          "id": "button_color",
          "label": "Buton Metin Rengi",
          "default": "#7367f0"
        },
        {
          "type": "header",
          "content": "‚öôÔ∏è Geli≈ümi≈ü"
        },
        {
          "type": "textarea",
          "id": "custom_css",
          "label": "√ñzel CSS (Block)",
          "info": "Bu block i√ßin √∂zel CSS"
        }
      ]
    },
    {
      "type": "product",
      "name": "Product",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "header",
          "content": "Badges"
        },
        {
          "type": "checkbox",
          "id": "show_4d_badge",
          "label": "Show 4D Badge",
          "default": true
        },
        {
          "type": "text",
          "id": "custom_badge",
          "label": "Custom Badge Text"
        },
        {
          "type": "color",
          "id": "badge_color",
          "label": "Custom Badge Color",
          "default": "#28c76f"
        },
        {
          "type": "header",
          "content": "Rating"
        },
        {
          "type": "range",
          "id": "rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "default": 5,
          "label": "Star Rating"
        },
        {
          "type": "number",
          "id": "review_count",
          "label": "Review Count",
          "default": 128
        },
        {
          "type": "header",
          "content": "Features"
        },
        {
          "type": "checkbox",
          "id": "show_upload",
          "label": "Show Upload Button",
          "default": true
        },
        {
          "type": "text",
          "id": "upload_text",
          "label": "Upload Button Text",
          "default": "My Device"
        },
        {
          "type": "text",
          "id": "perfect_for",
          "label": "Perfect For Label",
          "placeholder": "e.g., Hoodies, T-Shirts"
        },
        {
          "type": "header",
          "content": "Button Settings"
        },
        {
          "type": "paragraph",
          "content": "‚ö†Ô∏è These settings only work when 'Enable Upload Mode' is OFF"
        },
        {
          "type": "select",
          "id": "button_action",
          "label": "Button Action",
          "options": [
            { "value": "add_to_cart", "label": "Add to Cart" },
            { "value": "go_to_product", "label": "Go to Product Page" }
          ],
          "default": "add_to_cart"
        },
        {
          "type": "text",
          "id": "button_text",
          "label": "Button Text",
          "placeholder": "Add to Cart / View Product"
        },
        {
          "type": "textarea",
          "id": "custom_css",
          "label": "√ñzel CSS (Block)",
          "info": "Bu block i√ßin √∂zel CSS"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "3D Carousel 4D",
      "category": "Products",
      "blocks": [
        { "type": "product" },
        { "type": "product" },
        { "type": "product" },
        { "type": "product" },
        { "type": "product" }
      ]
    }
  ]
}
{% endschema %}
