<!doctype html>
<html
  lang="{{ request.locale.iso_code }}"
  class="layout-navbar-fixed layout-wide"
  dir="{{ request.locale.text_direction }}"
  data-skin="default"
  data-bs-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <title>{{ page_title }} - {{ shop.name }}</title>
    <meta name="description" content="{{ page_description | default: shop.description }}" />
    
    <!-- Canonical URL -->
    <link rel="canonical" href="{{ canonical_url }}" />
    
    <!-- DNS Prefetch for third-party resources -->
    <link rel="dns-prefetch" href="https://cdn.shopify.com">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    
    <!-- Preconnect for performance (critical resources) -->
    <link rel="preconnect" href="https://cdn.shopify.com" crossorigin />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    
    <!-- Favicon -->
    {%- if settings.favicon != blank -%}
      <link rel="icon" type="image/png" href="{{ settings.favicon | image_url: width: 32, height: 32 }}">
    {%- endif -%}
    
    <!-- Theme CSS - Critical (must load first) -->
    {{ 'theme.css' | asset_url | stylesheet_tag }}
    
    <!-- Page-specific CSS - Only load when needed -->
    {% if template.name == 'product' %}
      {{ 'product-page.css' | asset_url | stylesheet_tag }}
    {% endif %}
    
    <!-- Shopify Content for Header - Will be delayed by our script -->
    {{ content_for_header }}
    
    <!-- SEO Schema 2026 - JSON-LD Structured Data -->
    {% render 'seo-schema-2026' %}
    
    <!-- Third-Party Script Delay: Pause heavy scripts until user interaction -->
    <script>
      // Delay third-party scripts until user interaction (scroll, click, touch, keydown)
      // This significantly improves LCP and INP scores
      (function() {
        var delayedScripts = [];
        var userInteracted = false;
        var delayTime = 5000; // Fallback: 5 seconds if no interaction
        
        // Find and pause third-party scripts from apps
        var thirdPartyDomains = [
          'klaviyo',
          'judge.me', 
          'judgeme',
          'clarity.ms',
          'facebook',
          'fbevents',
          'drip',
          'googletagmanager',
          'google-analytics',
          'hotjar',
          'loox',
          'yotpo',
          'stamped',
          'okendo'
        ];
        
        // Function to check if script is third-party
        function isThirdParty(src) {
          if (!src) return false;
          return thirdPartyDomains.some(function(domain) {
            return src.toLowerCase().indexOf(domain) !== -1;
          });
        }
        
        // Override script execution for third-party
        var originalCreateElement = document.createElement;
        document.createElement = function(tagName) {
          var element = originalCreateElement.call(document, tagName);
          
          if (tagName.toLowerCase() === 'script') {
            var originalSetAttribute = element.setAttribute;
            element.setAttribute = function(name, value) {
              if (name === 'src' && isThirdParty(value) && !userInteracted) {
                // Store for later execution
                delayedScripts.push({ element: element, src: value });
                return;
              }
              return originalSetAttribute.call(this, name, value);
            };
          }
          
          return element;
        };
        
        // Load delayed scripts
        function loadDelayedScripts() {
          if (userInteracted) return;
          userInteracted = true;
          
          // Restore original createElement
          document.createElement = originalCreateElement;
          
          // Load stored scripts with slight delay between each
          delayedScripts.forEach(function(item, index) {
            setTimeout(function() {
              var script = document.createElement('script');
              script.src = item.src;
              if (item.element.async) script.async = true;
              if (item.element.defer) script.defer = true;
              document.head.appendChild(script);
            }, index * 100);
          });
          
          // Remove event listeners
          ['scroll', 'click', 'touchstart', 'keydown', 'mousemove'].forEach(function(event) {
            window.removeEventListener(event, loadDelayedScripts);
          });
        }
        
        // Add event listeners for user interaction
        ['scroll', 'click', 'touchstart', 'keydown', 'mousemove'].forEach(function(event) {
          window.addEventListener(event, loadDelayedScripts, { once: true, passive: true });
        });
        
        // Fallback: Load after delay if no interaction
        setTimeout(loadDelayedScripts, delayTime);
      })();
    </script>
    
    <style>
      /* FOUC Prevention - Hide body until CSS loads */
      html:not(.loaded) body {
        visibility: hidden;
        opacity: 0;
      }
      
      html.loaded body {
        visibility: visible;
        opacity: 1;
        transition: opacity 0.15s ease;
      }
      
      /* Critical CSS - Above the fold */
      :root {
        --cp-primary: {{ settings.color_primary | default: '#7367F0' }};
        --cp-primary-rgb: {{ settings.color_primary | default: '#7367F0' | color_to_rgb | replace: 'rgb(', '' | replace: ')', '' }};
        --cp-success: {{ settings.color_success | default: '#28c76f' }};
        --cp-danger: {{ settings.color_danger | default: '#ea5455' }};
        --cp-warning: {{ settings.color_warning | default: '#ff9f43' }};
        --cp-info: {{ settings.color_info | default: '#00cfe8' }};
        --cp-body-bg: {{ settings.color_body_bg | default: '#f8f8f8' }};
        --cp-card-bg: {{ settings.color_card_bg | default: '#ffffff' }};
        --cp-heading-color: {{ settings.color_heading | default: '#5e5873' }};
        --cp-body-color: {{ settings.color_body_text | default: '#6e6b7b' }};
        --cp-muted-color: {{ settings.color_muted | default: '#b9b9c3' }};
        --cp-border-color: {{ settings.color_border | default: '#ebe9f1' }};
        --cp-heading-font: '{{ settings.heading_font | default: 'Montserrat' }}', sans-serif;
        --cp-heading-weight: {{ settings.heading_weight | default: '500' }};
      }
      
      /* Dynamic Heading Styles */
      .cp-glass-title,
      .cp-glass-badge,
      .header-title-4d,
      .gold-foil-text,
      .gold-foil-text .foil-layer,
      .cp-section-title,
      .cp-header-title,
      .cp-featured-title {
        font-family: var(--cp-heading-font) !important;
        font-weight: var(--cp-heading-weight) !important;
        {% if settings.heading_uppercase %}
        text-transform: uppercase !important;
        {% endif %}
      }
      
      body {
        font-family: 'Montserrat', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background-color: var(--cp-body-bg);
        color: var(--cp-body-color);
        margin: 0;
        padding: 0;
        overflow-x: hidden;
      }
      
      html {
        overflow-x: hidden;
      }
      
      .main-content {
        min-height: 60vh;
      }
      
      /* Skip to content - Accessibility */
      .skip-to-content-link {
        position: absolute;
        top: -100px;
        left: 50%;
        transform: translateX(-50%);
        background: var(--cp-primary);
        color: #fff;
        padding: 12px 24px;
        border-radius: 0 0 8px 8px;
        text-decoration: none;
        font-weight: 600;
        z-index: 9999;
        transition: top 0.3s ease;
      }
      
      .skip-to-content-link:focus {
        top: 0;
        outline: 2px solid #fff;
        outline-offset: 2px;
      }
      
      .visually-hidden-focusable:not(:focus):not(:focus-within) {
        position: absolute !important;
        width: 1px !important;
        height: 1px !important;
        padding: 0 !important;
        margin: -1px !important;
        overflow: hidden !important;
        clip: rect(0, 0, 0, 0) !important;
        white-space: nowrap !important;
        border: 0 !important;
      }
    </style>
  </head>

  <body class="template-{{ template.name }}{% if template.suffix %} template-{{ template.name }}-{{ template.suffix }}{% endif %}">
    
    <!-- Skip to content for accessibility -->
    <a class="skip-to-content-link visually-hidden-focusable" href="#MainContent">
      {{ 'accessibility.skip_to_content' | t }}
    </a>
    
    <!-- Header Section -->
    {% section 'header' %}
    
    <!-- Main Content -->
    <main id="MainContent" class="main-content" role="main">
      {{ content_for_layout }}
    </main>
    
    <!-- Footer Section -->
    {% section 'footer' %}
    
    <!-- Drawer Cart (Ajax Mini Cart) -->
    {% render 'drawer-cart' %}
    
    <!-- Chat Widget (WhatsApp & Support) -->
    {% render 'chat-widget' %}
    
    <!-- Bottom Navigation (Mobile) -->
    {% render 'bottom-nav' %}
    
    <!-- Theme JavaScript - Deferred for performance -->
    <script src="{{ 'theme.js' | asset_url }}" defer></script>
    
    <!-- Delivery Widget System (Product & Cart pages only) -->
    {% if template.name == 'product' or template.name == 'cart' %}
      <script src="{{ 'delivery-mini-strip.js' | asset_url }}" defer></script>
      <script src="{{ 'delivery-widget.js' | asset_url }}" defer></script>
      {% render 'delivery-config' %}
    {% endif %}
    
    <!-- Performance: Instant page transitions (prefetch on hover) -->
    <script>
      // FOUC Prevention
      document.documentElement.classList.add('loaded');
      
      // Load non-critical CSS asynchronously (fonts, icons)
      (function() {
        var nonCriticalCSS = [
          'https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap',
          'https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.44.0/tabler-icons.min.css',
          'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css'
        ];
        
        // Use requestIdleCallback for best performance, fallback to setTimeout
        var loadCSS = function() {
          nonCriticalCSS.forEach(function(href) {
            var link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = href;
            document.head.appendChild(link);
          });
        };
        
        if ('requestIdleCallback' in window) {
          requestIdleCallback(loadCSS, { timeout: 2000 });
        } else {
          setTimeout(loadCSS, 100);
        }
      })();
      
      // Prefetch pages on link hover for instant navigation
      if ('IntersectionObserver' in window) {
        const prefetchedUrls = new Set();
        document.addEventListener('mouseover', function(e) {
          const link = e.target.closest('a');
          if (link && link.href && link.href.startsWith(window.location.origin) && !prefetchedUrls.has(link.href)) {
            prefetchedUrls.add(link.href);
            const prefetch = document.createElement('link');
            prefetch.rel = 'prefetch';
            prefetch.href = link.href;
            document.head.appendChild(prefetch);
          }
        }, { passive: true });
      }
      
      // Lazy load images that enter viewport (fallback for older browsers)
      if ('loading' in HTMLImageElement.prototype === false) {
        document.addEventListener('DOMContentLoaded', function() {
          const images = document.querySelectorAll('img[loading="lazy"]');
          const imageObserver = new IntersectionObserver(function(entries) {
            entries.forEach(function(entry) {
              if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src || img.src;
                imageObserver.unobserve(img);
              }
            });
          });
          images.forEach(function(img) { imageObserver.observe(img); });
        });
      }
    </script>
    
  </body>
</html>
