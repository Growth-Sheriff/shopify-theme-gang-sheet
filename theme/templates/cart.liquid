{% comment %}
  ============================================
  CART PAGE - DTF Transfer Marketing Edition
  ============================================
  Features:
  - Free Shipping Progress Bar
  - Volume Discount Upsell
  - Cross-sell Recommendations  
  - Frequently Bought Together
  - Urgency Countdown Timer
  - Trust Badges & Security
  - Express Checkout Options
  - Gift Wrap & Special Notes
  - Loyalty Points Display
  - Mobile-First Responsive
  ============================================
{% endcomment %}

{{ 'cart.css' | asset_url | stylesheet_tag }}

{%- comment -%} SETTINGS {%- endcomment -%}
{%- assign free_shipping_threshold = 5000 -%}
{%- assign currency_symbol = cart.currency.symbol | default: '$' -%}
{%- assign free_shipping_amount = free_shipping_threshold | divided_by: 100.0 -%}

<div class="cart-page" id="cart-page">
  <div class="container">
    
    {%- comment -%} ===== CART HEADER ===== {%- endcomment -%}
    <div class="cart-header">
      <div class="cart-header-left">
        <h1 class="cart-title">
          <i class="ti ti-shopping-cart"></i>
          {{ 'cart.general.title' | t | default: 'Shopping Cart' }}
        </h1>
        {%- if cart.item_count > 0 -%}
          <span class="cart-item-count">{{ cart.item_count }} {{ cart.item_count | pluralize: 'item', 'items' }}</span>
        {%- endif -%}
      </div>
      <a href="{{ routes.all_products_collection_url }}" class="continue-shopping-link">
        <i class="ti ti-arrow-left"></i>
        Continue Shopping
      </a>
    </div>

    {%- if cart.item_count > 0 -%}
      
      {%- comment -%} ===== FREE SHIPPING PROGRESS BAR ===== {%- endcomment -%}
      {%- assign amount_needed = free_shipping_threshold | minus: cart.total_price -%}
      {%- assign progress_percentage = cart.total_price | times: 100 | divided_by: free_shipping_threshold -%}
      {%- if progress_percentage > 100 -%}
        {%- assign progress_percentage = 100 -%}
      {%- endif -%}
      
      <div class="free-shipping-bar">
        <div class="shipping-bar-content">
          {%- if amount_needed > 0 -%}
            <div class="shipping-message">
              <i class="ti ti-truck"></i>
              <span>Add <strong>{{ amount_needed | money }}</strong> more for <strong>FREE SHIPPING!</strong></span>
            </div>
          {%- else -%}
            <div class="shipping-message shipping-unlocked">
              <i class="ti ti-circle-check"></i>
              <span><strong>Congratulations!</strong> You've unlocked FREE SHIPPING!</span>
            </div>
          {%- endif -%}
          <div class="shipping-progress-track">
            <div class="shipping-progress-fill" style="width: {{ progress_percentage }}%">
              <div class="progress-glow"></div>
            </div>
            <div class="shipping-milestones">
              <span class="milestone" style="left: 0%">{{ currency_symbol }}0</span>
              <span class="milestone" style="left: 50%">{{ currency_symbol }}{{ free_shipping_amount | divided_by: 2 | round }}</span>
              <span class="milestone milestone-goal" style="left: 100%">
                <i class="ti ti-truck"></i>
                {{ currency_symbol }}{{ free_shipping_amount | round }}
              </span>
            </div>
          </div>
        </div>
      </div>

      {%- comment -%} ===== URGENCY TIMER ===== {%- endcomment -%}
      <div class="urgency-banner">
        <div class="urgency-content">
          <i class="ti ti-clock-bolt"></i>
          <span>Order within <strong id="countdown-timer">--:--:--</strong> for <strong>same-day processing!</strong></span>
        </div>
        <div class="urgency-badge">
          <i class="ti ti-bolt"></i>
          Fast Processing
        </div>
      </div>

      <form action="{{ routes.cart_url }}" method="post" id="cart-form" class="cart-form">
        <div class="cart-layout">
          
          {%- comment -%} ===== MAIN CART CONTENT ===== {%- endcomment -%}
          <div class="cart-main">
            
            {%- comment -%} CART ITEMS LIST {%- endcomment -%}
            <div class="cart-items-container">
              <div class="cart-items-header">
                <span class="header-product">Product</span>
                <span class="header-price">Price</span>
                <span class="header-quantity">Quantity</span>
                <span class="header-total">Total</span>
              </div>
              
              <div class="cart-items" id="cart-items">
                {%- for item in cart.items -%}
                  <div class="cart-item" data-key="{{ item.key }}" data-index="{{ forloop.index }}">
                    
                    {%- comment -%} PRODUCT IMAGE {%- endcomment -%}
                    <div class="cart-item-image">
                      <a href="{{ item.url }}">
                        {%- if item.image -%}
                          <img src="{{ item.image | image_url: width: 200 }}" 
                               alt="{{ item.title | escape }}"
                               loading="lazy">
                        {%- else -%}
                          <div class="placeholder-image">
                            <i class="ti ti-photo"></i>
                          </div>
                        {%- endif -%}
                      </a>
                      {%- comment -%} 4D Badge if applicable {%- endcomment -%}
                      {%- if item.product.tags contains '4d' or item.product.tags contains '4D' -%}
                        <span class="item-badge badge-4d">4D</span>
                      {%- endif -%}
                      {%- if item.product.tags contains 'bestseller' -%}
                        <span class="item-badge badge-best">Best</span>
                      {%- endif -%}
                    </div>

                    {%- comment -%} PRODUCT DETAILS {%- endcomment -%}
                    <div class="cart-item-details">
                      <div class="item-vendor">{{ item.vendor }}</div>
                      <h3 class="item-title">
                        <a href="{{ item.url }}">{{ item.product.title }}</a>
                      </h3>
                      {%- if item.variant.title != 'Default Title' -%}
                        <div class="item-variant">
                          <i class="ti ti-palette"></i>
                          {{ item.variant.title }}
                        </div>
                      {%- endif -%}
                      
                      {%- comment -%} Line item properties (uploaded files etc) {%- endcomment -%}
                      {%- if item.properties.size > 0 -%}
                        <div class="item-properties">
                          {%- for property in item.properties -%}
                            {%- unless property.last == blank -%}
                              <div class="property-item">
                                <span class="property-name">{{ property.first }}:</span>
                                {%- if property.last contains '/uploads/' -%}
                                  <a href="{{ property.last }}" target="_blank" class="property-file">
                                    <i class="ti ti-file"></i> View File
                                  </a>
                                {%- else -%}
                                  <span class="property-value">{{ property.last }}</span>
                                {%- endif -%}
                              </div>
                            {%- endunless -%}
                          {%- endfor -%}
                        </div>
                      {%- endif -%}
                      
                      {%- comment -%} Mobile Price {%- endcomment -%}
                      <div class="item-price-mobile">
                        {%- if item.original_price > item.final_price -%}
                          <span class="price-compare">{{ item.original_price | money }}</span>
                        {%- endif -%}
                        <span class="price-current">{{ item.final_price | money }}</span>
                      </div>
                      
                      {%- comment -%} Save for Later {%- endcomment -%}
                      <button type="button" class="save-for-later-btn" data-product-id="{{ item.product.id }}">
                        <i class="ti ti-heart"></i>
                        <span>Save for Later</span>
                      </button>
                    </div>

                    {%- comment -%} PRICE (Desktop) {%- endcomment -%}
                    <div class="cart-item-price">
                      {%- if item.original_price > item.final_price -%}
                        <span class="price-compare">{{ item.original_price | money }}</span>
                      {%- endif -%}
                      <span class="price-current">{{ item.final_price | money }}</span>
                      {%- if item.original_price > item.final_price -%}
                        {%- assign savings = item.original_price | minus: item.final_price -%}
                        <span class="price-savings">Save {{ savings | money }}</span>
                      {%- endif -%}
                    </div>

                    {%- comment -%} QUANTITY CONTROLS {%- endcomment -%}
                    <div class="cart-item-quantity">
                      <div class="quantity-selector">
                        <button type="button" 
                                class="qty-btn qty-minus" 
                                data-key="{{ item.key }}"
                                data-action="decrease"
                                aria-label="Decrease quantity">
                          <i class="ti ti-minus"></i>
                        </button>
                        <input type="number" 
                               name="updates[{{ item.key }}]" 
                               value="{{ item.quantity }}" 
                               min="0" 
                               max="999"
                               class="qty-input"
                               data-key="{{ item.key }}"
                               aria-label="Quantity">
                        <button type="button" 
                                class="qty-btn qty-plus" 
                                data-key="{{ item.key }}"
                                data-action="increase"
                                aria-label="Increase quantity">
                          <i class="ti ti-plus"></i>
                        </button>
                      </div>
                      
                      {%- comment -%} Volume Discount Indicator {%- endcomment -%}
                      {%- if item.quantity >= 5 -%}
                        <div class="volume-badge">
                          <i class="ti ti-discount-2"></i>
                          Bulk Savings!
                        </div>
                      {%- elsif item.quantity >= 3 -%}
                        <div class="volume-hint">
                          Add {{ 5 | minus: item.quantity }} more for bulk discount!
                        </div>
                      {%- endif -%}
                    </div>

                    {%- comment -%} LINE TOTAL {%- endcomment -%}
                    <div class="cart-item-total">
                      <span class="line-total">{{ item.final_line_price | money }}</span>
                      {%- if item.original_line_price > item.final_line_price -%}
                        <span class="line-savings">
                          You save {{ item.original_line_price | minus: item.final_line_price | money }}
                        </span>
                      {%- endif -%}
                    </div>

                    {%- comment -%} REMOVE BUTTON {%- endcomment -%}
                    <button type="button" 
                            class="remove-item-btn" 
                            data-key="{{ item.key }}"
                            aria-label="Remove {{ item.title }}">
                      <i class="ti ti-trash"></i>
                    </button>
                  </div>
                {%- endfor -%}
              </div>
            </div>

            {%- comment -%} ===== VOLUME DISCOUNT UPSELL ===== {%- endcomment -%}
            <div class="volume-discount-section">
              <div class="volume-header">
                <i class="ti ti-chart-arrows-vertical"></i>
                <h3>Unlock Volume Discounts!</h3>
              </div>
              <div class="volume-tiers">
                <div class="tier {% if cart.item_count >= 5 %}tier-active{% endif %}">
                  <span class="tier-qty">5+</span>
                  <span class="tier-discount">10% OFF</span>
                </div>
                <div class="tier-connector"></div>
                <div class="tier {% if cart.item_count >= 10 %}tier-active{% endif %}">
                  <span class="tier-qty">10+</span>
                  <span class="tier-discount">15% OFF</span>
                </div>
                <div class="tier-connector"></div>
                <div class="tier {% if cart.item_count >= 25 %}tier-active{% endif %}">
                  <span class="tier-qty">25+</span>
                  <span class="tier-discount">20% OFF</span>
                </div>
                <div class="tier-connector"></div>
                <div class="tier {% if cart.item_count >= 50 %}tier-active{% endif %}">
                  <span class="tier-qty">50+</span>
                  <span class="tier-discount">25% OFF</span>
                </div>
              </div>
              {%- if cart.item_count < 5 -%}
                <p class="volume-cta">Add {{ 5 | minus: cart.item_count }} more items to unlock <strong>10% OFF!</strong></p>
              {%- elsif cart.item_count < 10 -%}
                <p class="volume-cta">Add {{ 10 | minus: cart.item_count }} more items to unlock <strong>15% OFF!</strong></p>
              {%- elsif cart.item_count < 25 -%}
                <p class="volume-cta">Add {{ 25 | minus: cart.item_count }} more items to unlock <strong>20% OFF!</strong></p>
              {%- endif -%}
            </div>

            {%- comment -%} ===== CROSS-SELL RECOMMENDATIONS ===== {%- endcomment -%}
            <div class="cross-sell-section">
              <div class="cross-sell-header">
                <i class="ti ti-sparkles"></i>
                <h3>Complete Your Order</h3>
                <p>Frequently purchased with items in your cart</p>
              </div>
              <div class="cross-sell-products">
                {%- comment -%} Get complementary products based on cart items {%- endcomment -%}
                {%- assign cross_sell_handles = 'transfer-paper,heat-press-pillows,dtf-ink-set,protective-sheets' | split: ',' -%}
                {%- assign shown_count = 0 -%}
                
                {%- for handle in cross_sell_handles -%}
                  {%- assign cross_product = all_products[handle] -%}
                  {%- if cross_product != blank and shown_count < 4 -%}
                    {%- assign in_cart = false -%}
                    {%- for item in cart.items -%}
                      {%- if item.product.handle == handle -%}
                        {%- assign in_cart = true -%}
                        {%- break -%}
                      {%- endif -%}
                    {%- endfor -%}
                    
                    {%- unless in_cart -%}
                      {%- assign shown_count = shown_count | plus: 1 -%}
                      <div class="cross-sell-card">
                        <div class="cross-sell-image">
                          {%- if cross_product.featured_image -%}
                            <img src="{{ cross_product.featured_image | image_url: width: 150 }}" 
                                 alt="{{ cross_product.title | escape }}"
                                 loading="lazy">
                          {%- else -%}
                            <div class="placeholder-image">
                              <i class="ti ti-photo"></i>
                            </div>
                          {%- endif -%}
                        </div>
                        <div class="cross-sell-info">
                          <h4>{{ cross_product.title | truncate: 30 }}</h4>
                          <div class="cross-sell-price">
                            {%- if cross_product.compare_at_price > cross_product.price -%}
                              <span class="price-compare">{{ cross_product.compare_at_price | money }}</span>
                            {%- endif -%}
                            <span class="price-current">{{ cross_product.price | money }}</span>
                          </div>
                        </div>
                        <button type="button" 
                                class="cross-sell-add-btn" 
                                data-variant-id="{{ cross_product.selected_or_first_available_variant.id }}">
                          <i class="ti ti-plus"></i>
                          Add
                        </button>
                      </div>
                    {%- endunless -%}
                  {%- endif -%}
                {%- endfor -%}
                
                {%- comment -%} If no predefined cross-sells, show recommendations {%- endcomment -%}
                {%- if shown_count == 0 -%}
                  {%- assign first_item = cart.items.first -%}
                  {%- if first_item.product.collections.size > 0 -%}
                    {%- assign rec_collection = first_item.product.collections.first -%}
                    {%- for product in rec_collection.products limit: 4 -%}
                      {%- assign in_cart = false -%}
                      {%- for item in cart.items -%}
                        {%- if item.product.id == product.id -%}
                          {%- assign in_cart = true -%}
                          {%- break -%}
                        {%- endif -%}
                      {%- endfor -%}
                      {%- unless in_cart -%}
                        <div class="cross-sell-card">
                          <div class="cross-sell-image">
                            {%- if product.featured_image -%}
                              <img src="{{ product.featured_image | image_url: width: 150 }}" 
                                   alt="{{ product.title | escape }}"
                                   loading="lazy">
                            {%- endif -%}
                          </div>
                          <div class="cross-sell-info">
                            <h4>{{ product.title | truncate: 30 }}</h4>
                            <div class="cross-sell-price">
                              <span class="price-current">{{ product.price | money }}</span>
                            </div>
                          </div>
                          <button type="button" 
                                  class="cross-sell-add-btn" 
                                  data-variant-id="{{ product.selected_or_first_available_variant.id }}">
                            <i class="ti ti-plus"></i>
                            Add
                          </button>
                        </div>
                      {%- endunless -%}
                    {%- endfor -%}
                  {%- endif -%}
                {%- endif -%}
              </div>
            </div>

            {%- comment -%} ===== GIFT WRAP & ORDER NOTES ===== {%- endcomment -%}
            <div class="order-extras">
              <div class="extras-grid">
                
                {%- comment -%} Gift Wrap Option {%- endcomment -%}
                <div class="extra-option gift-wrap-option">
                  <label class="extra-checkbox">
                    <input type="checkbox" name="attributes[Gift Wrap]" value="Yes" id="gift-wrap-checkbox">
                    <span class="checkbox-custom"></span>
                    <div class="extra-content">
                      <i class="ti ti-gift"></i>
                      <div class="extra-text">
                        <strong>Add Gift Wrapping</strong>
                        <span>+$4.99 - Includes gift message</span>
                      </div>
                    </div>
                  </label>
                  <div class="gift-message-container" id="gift-message-container" style="display: none;">
                    <textarea name="attributes[Gift Message]" placeholder="Enter your gift message..." maxlength="200"></textarea>
                  </div>
                </div>
                
                {%- comment -%} Order Notes {%- endcomment -%}
                <div class="extra-option order-notes-option">
                  <label class="extra-label" for="order-notes">
                    <i class="ti ti-notes"></i>
                    <strong>Special Instructions</strong>
                  </label>
                  <textarea name="note" id="order-notes" placeholder="Add any special requests or notes for your order..." rows="3">{{ cart.note }}</textarea>
                </div>
              </div>
            </div>

          </div>

          {%- comment -%} ===== CART SIDEBAR (Summary) ===== {%- endcomment -%}
          <div class="cart-sidebar">
            <div class="summary-card">
              <h3 class="summary-title">
                <i class="ti ti-receipt"></i>
                Order Summary
              </h3>

              {%- comment -%} Summary Lines {%- endcomment -%}
              <div class="summary-lines">
                <div class="summary-row">
                  <span>Subtotal ({{ cart.item_count }} items)</span>
                  <span>{{ cart.items_subtotal_price | money }}</span>
                </div>
                
                {%- if cart.cart_level_discount_applications.size > 0 -%}
                  {%- for discount in cart.cart_level_discount_applications -%}
                    <div class="summary-row discount-row">
                      <span>
                        <i class="ti ti-tag"></i>
                        {{ discount.title }}
                      </span>
                      <span class="discount-amount">-{{ discount.total_allocated_amount | money }}</span>
                    </div>
                  {%- endfor -%}
                {%- endif -%}
                
                <div class="summary-row shipping-row">
                  <span>Shipping</span>
                  <span>
                    {%- if cart.total_price >= free_shipping_threshold -%}
                      <span class="free-shipping-badge">FREE</span>
                    {%- else -%}
                      Calculated at checkout
                    {%- endif -%}
                  </span>
                </div>
                
                <div class="summary-row tax-row">
                  <span>Tax</span>
                  <span>Calculated at checkout</span>
                </div>
              </div>

              {%- comment -%} Coupon Code {%- endcomment -%}
              <div class="coupon-section">
                <button type="button" class="coupon-toggle" id="coupon-toggle">
                  <i class="ti ti-ticket"></i>
                  Have a coupon code?
                  <i class="ti ti-chevron-down"></i>
                </button>
                <div class="coupon-input-container" id="coupon-container" style="display: none;">
                  <input type="text" id="coupon-input" placeholder="Enter coupon code">
                  <button type="button" class="apply-coupon-btn" id="apply-coupon">Apply</button>
                </div>
              </div>

              {%- comment -%} Total {%- endcomment -%}
              <div class="summary-total">
                <span>Estimated Total</span>
                <span class="total-amount">{{ cart.total_price | money }}</span>
              </div>

              {%- comment -%} Savings Badge {%- endcomment -%}
              {%- assign total_savings = 0 -%}
              {%- for item in cart.items -%}
                {%- if item.original_line_price > item.final_line_price -%}
                  {%- assign item_savings = item.original_line_price | minus: item.final_line_price -%}
                  {%- assign total_savings = total_savings | plus: item_savings -%}
                {%- endif -%}
              {%- endfor -%}
              {%- if total_savings > 0 -%}
                <div class="total-savings-badge">
                  <i class="ti ti-piggy-bank"></i>
                  You're saving <strong>{{ total_savings | money }}</strong> on this order!
                </div>
              {%- endif -%}

              {%- comment -%} Checkout Button {%- endcomment -%}
              <button type="submit" name="checkout" class="checkout-btn primary-checkout">
                <i class="ti ti-lock"></i>
                <span>Secure Checkout</span>
                <span class="checkout-amount">{{ cart.total_price | money }}</span>
              </button>

              {%- comment -%} Express Checkout {%- endcomment -%}
              <div class="express-checkout">
                <div class="express-divider">
                  <span>or checkout faster with</span>
                </div>
                <div class="express-buttons">
                  {{ content_for_additional_checkout_buttons }}
                </div>
              </div>

              {%- comment -%} Trust & Security Badges {%- endcomment -%}
              <div class="trust-section">
                <div class="trust-badges">
                  <div class="trust-badge">
                    <i class="ti ti-shield-check"></i>
                    <span>Secure SSL</span>
                  </div>
                  <div class="trust-badge">
                    <i class="ti ti-refresh"></i>
                    <span>Easy Returns</span>
                  </div>
                  <div class="trust-badge">
                    <i class="ti ti-truck-delivery"></i>
                    <span>Fast Ship</span>
                  </div>
                </div>
                
                <div class="payment-icons">
                  <img src="https://cdn.shopify.com/s/files/1/0533/2089/files/payment-icons.png" alt="Payment Methods" loading="lazy">
                </div>
                
                <div class="guarantee-badge">
                  <i class="ti ti-rosette-discount-check"></i>
                  <div class="guarantee-text">
                    <strong>100% Satisfaction Guarantee</strong>
                    <span>30-day money back guarantee</span>
                  </div>
                </div>
              </div>

              {%- comment -%} Loyalty Points (if logged in) {%- endcomment -%}
              {%- if customer -%}
                <div class="loyalty-section">
                  <div class="loyalty-header">
                    <i class="ti ti-star"></i>
                    <span>Loyalty Points</span>
                  </div>
                  <div class="loyalty-info">
                    <p>Earn <strong>{{ cart.total_price | divided_by: 100 | round }}</strong> points on this order!</p>
                    <p class="points-balance">Your balance: {{ customer.metafields.loyalty.points | default: 0 }} pts</p>
                  </div>
                </div>
              {%- endif -%}

            </div>

            {%- comment -%} Delivery Estimate {%- endcomment -%}
            <div class="delivery-estimate">
              <div class="estimate-header">
                <i class="ti ti-calendar-event"></i>
                <strong>Estimated Delivery</strong>
              </div>
              <div class="estimate-dates">
                {%- assign today = 'now' | date: '%s' | plus: 0 -%}
                {%- assign processing_days = 1 -%}
                {%- assign shipping_days_min = 3 -%}
                {%- assign shipping_days_max = 5 -%}
                <span class="date-range">
                  {{ 'now' | date: '%s' | plus: 345600 | date: '%b %d' }} - {{ 'now' | date: '%s' | plus: 518400 | date: '%b %d' }}
                </span>
              </div>
              <p class="estimate-note">Order today and get it by the estimated date!</p>
            </div>

            {%- comment -%} Help Section {%- endcomment -%}
            <div class="help-section">
              <div class="help-item">
                <i class="ti ti-headset"></i>
                <div class="help-text">
                  <strong>Need Help?</strong>
                  <a href="/pages/contact">Contact Support</a>
                </div>
              </div>
              <div class="help-item">
                <i class="ti ti-message-circle"></i>
                <div class="help-text">
                  <strong>Questions?</strong>
                  <a href="#" onclick="window.Tawk_API && window.Tawk_API.maximize()">Live Chat</a>
                </div>
              </div>
            </div>
          </div>
          
        </div>
      </form>

      {%- comment -%} ===== FREQUENTLY BOUGHT TOGETHER ===== {%- endcomment -%}
      <div class="frequently-bought-section">
        <div class="fbt-header">
          <h3>
            <i class="ti ti-shopping-bag-check"></i>
            Frequently Bought Together
          </h3>
          <p>Complete your DTF printing setup with these popular combinations</p>
        </div>
        
        <div class="fbt-bundle">
          <div class="fbt-products">
            {%- assign bundle_total = 0 -%}
            {%- assign bundle_products = cart.items | map: 'product' | uniq | slice: 0, 3 -%}
            
            {%- for product in bundle_products -%}
              <div class="fbt-product">
                <div class="fbt-image">
                  {%- if product.featured_image -%}
                    <img src="{{ product.featured_image | image_url: width: 120 }}" alt="{{ product.title | escape }}">
                  {%- endif -%}
                </div>
                <div class="fbt-info">
                  <h4>{{ product.title | truncate: 25 }}</h4>
                  <span class="fbt-price">{{ product.price | money }}</span>
                </div>
                {%- assign bundle_total = bundle_total | plus: product.price -%}
              </div>
              {%- unless forloop.last -%}
                <span class="fbt-plus">+</span>
              {%- endunless -%}
            {%- endfor -%}
          </div>
          
          <div class="fbt-summary">
            <div class="fbt-total">
              <span class="fbt-label">Bundle Price:</span>
              <span class="fbt-original">{{ bundle_total | money }}</span>
              {%- assign bundle_discount = bundle_total | times: 0.15 | round -%}
              {%- assign bundle_final = bundle_total | minus: bundle_discount -%}
              <span class="fbt-discounted">{{ bundle_final | money }}</span>
            </div>
            <div class="fbt-savings">
              <i class="ti ti-tag"></i>
              Save 15% with this bundle!
            </div>
            <button type="button" class="fbt-add-all-btn">
              <i class="ti ti-shopping-cart-plus"></i>
              Add All to Cart
            </button>
          </div>
        </div>
      </div>

    {%- else -%}
      
      {%- comment -%} ===== EMPTY CART ===== {%- endcomment -%}
      <div class="empty-cart">
        <div class="empty-cart-content">
          <div class="empty-icon">
            <i class="ti ti-shopping-cart-off"></i>
          </div>
          <h2>Your Cart is Empty</h2>
          <p>Looks like you haven't added any items to your cart yet.</p>
          
          <a href="{{ routes.all_products_collection_url }}" class="start-shopping-btn">
            <i class="ti ti-shopping-bag"></i>
            Start Shopping
          </a>
          
          {%- comment -%} Popular Products for Empty Cart {%- endcomment -%}
          <div class="empty-cart-suggestions">
            <h3>Popular Products</h3>
            <div class="suggestion-products">
              {%- assign popular_collection = collections['best-sellers'] | default: collections.all -%}
              {%- for product in popular_collection.products limit: 4 -%}
                <a href="{{ product.url }}" class="suggestion-card">
                  <div class="suggestion-image">
                    {%- if product.featured_image -%}
                      <img src="{{ product.featured_image | image_url: width: 200 }}" alt="{{ product.title | escape }}">
                    {%- endif -%}
                  </div>
                  <h4>{{ product.title | truncate: 30 }}</h4>
                  <span class="suggestion-price">{{ product.price | money }}</span>
                </a>
              {%- endfor -%}
            </div>
          </div>
        </div>
      </div>
      
    {%- endif -%}
    
  </div>
</div>

{%- comment -%} ===== CART JAVASCRIPT ===== {%- endcomment -%}
<script>
document.addEventListener('DOMContentLoaded', function() {
  
  // ===== COUNTDOWN TIMER FOR SAME-DAY PROCESSING =====
  function updateCountdown() {
    const now = new Date();
    const cutoff = new Date();
    cutoff.setHours(14, 0, 0, 0); // 2 PM cutoff
    
    if (now > cutoff) {
      cutoff.setDate(cutoff.getDate() + 1);
    }
    
    const diff = cutoff - now;
    const hours = Math.floor(diff / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
    
    const timerEl = document.getElementById('countdown-timer');
    if (timerEl) {
      timerEl.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
  }
  
  updateCountdown();
  setInterval(updateCountdown, 1000);

  // ===== QUANTITY CONTROLS =====
  document.querySelectorAll('.qty-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const key = this.dataset.key;
      const action = this.dataset.action;
      const input = document.querySelector(`.qty-input[data-key="${key}"]`);
      let currentQty = parseInt(input.value) || 0;
      
      if (action === 'increase') {
        currentQty++;
      } else if (action === 'decrease' && currentQty > 0) {
        currentQty--;
      }
      
      input.value = currentQty;
      updateCartItem(key, currentQty);
    });
  });

  // ===== QUANTITY INPUT CHANGE =====
  document.querySelectorAll('.qty-input').forEach(input => {
    let timeout;
    input.addEventListener('change', function() {
      clearTimeout(timeout);
      timeout = setTimeout(() => {
        updateCartItem(this.dataset.key, parseInt(this.value) || 0);
      }, 500);
    });
  });

  // ===== REMOVE ITEM =====
  document.querySelectorAll('.remove-item-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const key = this.dataset.key;
      const item = this.closest('.cart-item');
      
      item.classList.add('removing');
      setTimeout(() => {
        updateCartItem(key, 0);
      }, 300);
    });
  });

  // ===== UPDATE CART ITEM (AJAX) =====
  function updateCartItem(key, quantity) {
    fetch('/cart/change.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: key, quantity: quantity })
    })
    .then(response => response.json())
    .then(cart => {
      location.reload();
    })
    .catch(error => {
      console.error('Error updating cart:', error);
    });
  }

  // ===== CROSS-SELL ADD TO CART =====
  document.querySelectorAll('.cross-sell-add-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const variantId = this.dataset.variantId;
      const originalContent = this.innerHTML;
      
      this.innerHTML = '<i class="ti ti-loader ti-spin"></i>';
      this.disabled = true;
      
      fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: variantId, quantity: 1 })
      })
      .then(response => response.json())
      .then(data => {
        this.innerHTML = '<i class="ti ti-check"></i> Added';
        this.classList.add('added');
        
        setTimeout(() => {
          location.reload();
        }, 1000);
      })
      .catch(error => {
        this.innerHTML = originalContent;
        this.disabled = false;
        console.error('Error:', error);
      });
    });
  });

  // ===== GIFT WRAP TOGGLE =====
  const giftWrapCheckbox = document.getElementById('gift-wrap-checkbox');
  const giftMessageContainer = document.getElementById('gift-message-container');
  
  if (giftWrapCheckbox && giftMessageContainer) {
    giftWrapCheckbox.addEventListener('change', function() {
      giftMessageContainer.style.display = this.checked ? 'block' : 'none';
    });
  }

  // ===== COUPON TOGGLE =====
  const couponToggle = document.getElementById('coupon-toggle');
  const couponContainer = document.getElementById('coupon-container');
  
  if (couponToggle && couponContainer) {
    couponToggle.addEventListener('click', function() {
      const isHidden = couponContainer.style.display === 'none';
      couponContainer.style.display = isHidden ? 'flex' : 'none';
      this.querySelector('.ti-chevron-down').style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0)';
    });
  }

  // ===== SAVE FOR LATER =====
  document.querySelectorAll('.save-for-later-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const productId = this.dataset.productId;
      
      // Store in localStorage
      let savedItems = JSON.parse(localStorage.getItem('savedForLater') || '[]');
      if (!savedItems.includes(productId)) {
        savedItems.push(productId);
        localStorage.setItem('savedForLater', JSON.stringify(savedItems));
      }
      
      this.innerHTML = '<i class="ti ti-heart-filled"></i> Saved';
      this.classList.add('saved');
    });
  });

  // ===== ANIMATE ELEMENTS ON SCROLL =====
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('animate-in');
      }
    });
  }, { threshold: 0.1 });

  document.querySelectorAll('.cross-sell-card, .fbt-product, .suggestion-card').forEach(el => {
    observer.observe(el);
  });
});
</script>
