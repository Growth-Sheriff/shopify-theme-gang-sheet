{% comment %}
  ============================================
  CART PAGE - Ultra Responsive & Psychology-Driven
  ============================================
  2-Column Desktop | Single Column Mobile
  100% Dynamic - No Static Text
  ============================================
{% endcomment %}

{{ 'cart-premium.css' | asset_url | stylesheet_tag }}

{% assign free_shipping_threshold = settings.free_shipping_threshold | default: 5000 %}
{% assign cart_urgency_enabled = settings.cart_urgency_timer | default: false %}
{% assign cart_urgency_minutes = settings.cart_urgency_minutes | default: 15 %}

<div class="cart-page">
  <div class="cart-wrapper">
    
    {%- comment -%} ═══ CART HEADER ═══ {%- endcomment -%}
    <header class="cart-page-header">
      <div class="cart-header-left">
        <a href="{{ routes.all_products_collection_url }}" class="cart-back-link">
          <i class="fa-solid fa-arrow-left"></i>
          <span>{{ 'cart.general.continue_shopping' | t | default: 'Continue Shopping' }}</span>
        </a>
      </div>
      <h1 class="cart-page-title">
        <i class="fa-solid fa-bag-shopping"></i>
        {{ 'cart.general.title' | t | default: 'Your Cart' }}
        <span class="cart-item-count">({{ cart.item_count }} {{ cart.item_count | pluralize: 'item', 'items' }})</span>
      </h1>
      <div class="cart-header-right"></div>
    </header>

    {%- if cart.item_count > 0 -%}

      {%- comment -%} ═══ FREE SHIPPING PROGRESS BAR ═══ {%- endcomment -%}
      {% assign remaining_for_free = free_shipping_threshold | minus: cart.total_price %}
      {% assign shipping_progress = cart.total_price | times: 100 | divided_by: free_shipping_threshold %}
      {% if shipping_progress > 100 %}{% assign shipping_progress = 100 %}{% endif %}
      
      <div class="free-shipping-bar">
        {% if remaining_for_free > 0 %}
          <div class="shipping-bar-text">
            <i class="fa-solid fa-truck-fast"></i>
            <span>
              {{ 'cart.general.free_shipping_remaining' | t: remaining: remaining_for_free | money | default: 'Add' }}
              <strong>{{ remaining_for_free | money }}</strong>
              {{ 'cart.general.for_free_shipping' | t | default: 'more for FREE shipping!' }}
            </span>
          </div>
        {% else %}
          <div class="shipping-bar-text qualified">
            <i class="fa-solid fa-circle-check"></i>
            <span>{{ 'cart.general.free_shipping_qualified' | t | default: "Congratulations! You've qualified for FREE shipping!" }}</span>
          </div>
        {% endif %}
        <div class="shipping-progress-track">
          <div class="shipping-progress-fill" style="width: {{ shipping_progress }}%"></div>
          <div class="shipping-progress-icon" style="left: {{ shipping_progress }}%">
            <i class="fa-solid fa-truck"></i>
          </div>
        </div>
        <div class="shipping-progress-labels">
          <span>{{ 0 | money }}</span>
          <span>{{ free_shipping_threshold | money }}</span>
        </div>
      </div>

      {%- comment -%} ═══ URGENCY TIMER (Optional) ═══ {%- endcomment -%}
      {% if cart_urgency_enabled %}
      <div class="cart-urgency-banner" data-minutes="{{ cart_urgency_minutes }}">
        <i class="fa-solid fa-clock"></i>
        <span>{{ 'cart.general.urgency_text' | t | default: 'Items reserved for' }}</span>
        <strong class="urgency-countdown">{{ cart_urgency_minutes }}:00</strong>
        <span>{{ 'cart.general.minutes' | t | default: 'minutes' }}</span>
      </div>
      {% endif %}

      {%- comment -%} ═══ MAIN CART LAYOUT ═══ {%- endcomment -%}
      <form action="{{ routes.cart_url }}" method="post" id="cart-form" class="cart-main-layout">
        
        {%- comment -%} ═══ LEFT COLUMN - CART ITEMS ═══ {%- endcomment -%}
        <div class="cart-items-column">
          
          <div class="cart-items-card">
            <div class="cart-card-header">
              <span class="card-header-icon"><i class="fa-solid fa-box"></i></span>
              <h3>{{ 'cart.general.items_in_cart' | t | default: 'Items in Your Cart' }}</h3>
              <span class="items-count-badge">{{ cart.item_count }}</span>
            </div>
            
            <div class="cart-items-list">
              {%- for item in cart.items -%}
              <div class="cart-line-item" data-key="{{ item.key }}" data-index="{{ forloop.index }}">
                
                {%- comment -%} Product Image {%- endcomment -%}
                <a href="{{ item.url }}" class="line-item-image">
                  {%- if item.image -%}
                    <img src="{{ item.image | image_url: width: 200 }}" 
                         alt="{{ item.title | escape }}" 
                         width="200" height="200" 
                         loading="lazy">
                  {%- else -%}
                    <div class="image-placeholder">
                      <i class="fa-solid fa-image"></i>
                    </div>
                  {%- endif -%}
                  
                  {%- comment -%} Sale Badge {%- endcomment -%}
                  {%- if item.original_price > item.final_price -%}
                    {% assign discount_percent = item.original_price | minus: item.final_price | times: 100 | divided_by: item.original_price %}
                    <span class="line-item-badge sale">-{{ discount_percent }}%</span>
                  {%- endif -%}
                </a>
                
                {%- comment -%} Product Details {%- endcomment -%}
                <div class="line-item-details">
                  <a href="{{ item.url }}" class="line-item-title">{{ item.product.title }}</a>
                  
                  {%- if item.variant.title != 'Default Title' -%}
                    <div class="line-item-variant">
                      {%- for option in item.product.options_with_values -%}
                        <span class="variant-option">
                          <span class="option-label">{{ option.name }}:</span>
                          <span class="option-value">{{ item.variant.options[forloop.index0] }}</span>
                        </span>
                      {%- endfor -%}
                    </div>
                  {%- endif -%}
                  
                  {%- comment -%} Line Item Properties {%- endcomment -%}
                  {%- if item.properties.size > 0 -%}
                    <div class="line-item-properties">
                      {%- for property in item.properties -%}
                        {%- unless property.last == blank -%}
                          <span class="property-item">
                            <span class="prop-label">{{ property.first }}:</span>
                            <span class="prop-value">{{ property.last }}</span>
                          </span>
                        {%- endunless -%}
                      {%- endfor -%}
                    </div>
                  {%- endif -%}
                  
                  {%- comment -%} Price {%- endcomment -%}
                  <div class="line-item-pricing">
                    {%- if item.original_price > item.final_price -%}
                      <span class="price-sale">{{ item.final_price | money }}</span>
                      <span class="price-original">{{ item.original_price | money }}</span>
                    {%- else -%}
                      <span class="price-regular">{{ item.final_price | money }}</span>
                    {%- endif -%}
                    <span class="price-each">/ {{ 'cart.label.each' | t | default: 'each' }}</span>
                  </div>
                </div>
                
                {%- comment -%} Actions Column {%- endcomment -%}
                <div class="line-item-actions">
                  {%- comment -%} Quantity Selector {%- endcomment -%}
                  <div class="quantity-selector">
                    <button type="button" class="qty-btn qty-minus" data-key="{{ item.key }}" aria-label="Decrease quantity">
                      <i class="fa-solid fa-minus"></i>
                    </button>
                    <input type="number" 
                           name="updates[{{ item.key }}]" 
                           value="{{ item.quantity }}" 
                           min="1" 
                           class="qty-input" 
                           data-key="{{ item.key }}"
                           aria-label="Quantity">
                    <button type="button" class="qty-btn qty-plus" data-key="{{ item.key }}" aria-label="Increase quantity">
                      <i class="fa-solid fa-plus"></i>
                    </button>
                  </div>
                  
                  {%- comment -%} Line Total {%- endcomment -%}
                  <div class="line-item-total" data-key="{{ item.key }}">
                    {{ item.final_line_price | money }}
                  </div>
                  
                  {%- comment -%} Remove Button {%- endcomment -%}
                  <button type="button" class="line-item-remove" data-key="{{ item.key }}" aria-label="{{ 'cart.general.remove' | t | default: 'Remove' }}">
                    <i class="fa-solid fa-trash-can"></i>
                  </button>
                </div>
                
              </div>
              {%- endfor -%}
            </div>
          </div>
          
          {%- comment -%} ═══ ORDER NOTES ═══ {%- endcomment -%}
          <div class="cart-notes-card">
            <div class="cart-card-header">
              <span class="card-header-icon"><i class="fa-solid fa-message"></i></span>
              <h3>{{ 'cart.general.order_note' | t | default: 'Order Notes' }}</h3>
            </div>
            <div class="cart-notes-content">
              <textarea name="note" 
                        id="cart-note" 
                        class="cart-note-input" 
                        placeholder="{{ 'cart.general.note_placeholder' | t | default: 'Add special instructions for your order...' }}">{{ cart.note }}</textarea>
            </div>
          </div>
          
        </div>

        {%- comment -%} ═══ RIGHT COLUMN - ORDER SUMMARY ═══ {%- endcomment -%}
        <div class="cart-summary-column">
          <div class="cart-summary-card">
            
            <div class="cart-card-header">
              <span class="card-header-icon"><i class="fa-solid fa-receipt"></i></span>
              <h3>{{ 'cart.general.order_summary' | t | default: 'Order Summary' }}</h3>
            </div>
            
            <div class="summary-details">
              {%- comment -%} Subtotal {%- endcomment -%}
              <div class="summary-row">
                <span class="summary-label">
                  {{ 'cart.general.subtotal' | t | default: 'Subtotal' }}
                  <span class="item-count-small">({{ cart.item_count }} {{ cart.item_count | pluralize: 'item', 'items' }})</span>
                </span>
                <span class="summary-value" id="cart-subtotal">{{ cart.total_price | money }}</span>
              </div>
              
              {%- comment -%} Shipping Estimate {%- endcomment -%}
              <div class="summary-row">
                <span class="summary-label">
                  {{ 'cart.general.shipping' | t | default: 'Shipping' }}
                </span>
                <span class="summary-value shipping-value" id="cart-shipping">
                  {%- if cart.total_price >= free_shipping_threshold -%}
                    <span class="free-badge">{{ 'cart.general.free' | t | default: 'FREE' }}</span>
                  {%- else -%}
                    {{ 'cart.general.calculated_at_checkout' | t | default: 'Calculated at checkout' }}
                  {%- endif -%}
                </span>
              </div>
              
              {%- comment -%} Tax Estimate {%- endcomment -%}
              {%- if cart.taxes_included -%}
              <div class="summary-row">
                <span class="summary-label">{{ 'cart.general.taxes' | t | default: 'Tax' }}</span>
                <span class="summary-value tax-included">{{ 'cart.general.taxes_included' | t | default: 'Included' }}</span>
              </div>
              {%- endif -%}
              
              {%- comment -%} Discount Codes Applied {%- endcomment -%}
              {%- if cart.cart_level_discount_applications.size > 0 -%}
                {%- for discount in cart.cart_level_discount_applications -%}
                <div class="summary-row discount-row">
                  <span class="summary-label">
                    <i class="fa-solid fa-tag"></i>
                    {{ discount.title }}
                  </span>
                  <span class="summary-value discount-value">-{{ discount.total_allocated_amount | money }}</span>
                </div>
                {%- endfor -%}
              {%- endif -%}
              
              <div class="summary-divider"></div>
              
              {%- comment -%} Total {%- endcomment -%}
              <div class="summary-row total-row">
                <span class="summary-label">{{ 'cart.general.total' | t | default: 'Total' }}</span>
                <span class="summary-value total-value" id="cart-total">{{ cart.total_price | money }}</span>
              </div>
              
              {%- comment -%} Savings {%- endcomment -%}
              {% assign total_savings = 0 %}
              {%- for item in cart.items -%}
                {% assign item_savings = item.original_price | minus: item.final_price | times: item.quantity %}
                {% assign total_savings = total_savings | plus: item_savings %}
              {%- endfor -%}
              {%- if total_savings > 0 -%}
              <div class="summary-savings">
                <i class="fa-solid fa-piggy-bank"></i>
                <span>{{ 'cart.general.you_save' | t | default: 'You save' }} <strong>{{ total_savings | money }}</strong> {{ 'cart.general.on_this_order' | t | default: 'on this order!' }}</span>
              </div>
              {%- endif -%}
            </div>
            
            {%- comment -%} Coupon Code Input {%- endcomment -%}
            <div class="coupon-section">
              <div class="coupon-header" data-toggle-coupon>
                <i class="fa-solid fa-ticket"></i>
                <span>{{ 'cart.general.have_coupon' | t | default: 'Have a coupon code?' }}</span>
                <i class="fa-solid fa-chevron-down coupon-toggle-icon"></i>
              </div>
              <div class="coupon-input-wrap" style="display: none;">
                <input type="text" class="coupon-input" placeholder="{{ 'cart.general.coupon_placeholder' | t | default: 'Enter code' }}" id="coupon-code-input">
                <button type="button" class="coupon-apply-btn" id="apply-coupon-btn">
                  {{ 'cart.general.apply' | t | default: 'Apply' }}
                </button>
              </div>
              <p class="coupon-note">{{ 'cart.general.coupon_note' | t | default: 'Discount codes are applied at checkout' }}</p>
            </div>
            
            {%- comment -%} Checkout Button {%- endcomment -%}
            <div class="checkout-section">
              <button type="submit" name="checkout" class="checkout-btn-primary">
                <i class="fa-solid fa-lock"></i>
                <span>{{ 'cart.general.checkout' | t | default: 'Secure Checkout' }}</span>
                <span class="checkout-total">{{ cart.total_price | money }}</span>
              </button>
              
              {%- comment -%} Additional Checkout Buttons (Shop Pay, PayPal, etc.) {%- endcomment -%}
              {%- if additional_checkout_buttons -%}
              <div class="additional-checkouts">
                <span class="or-divider">{{ 'cart.general.or' | t | default: 'or' }}</span>
                {{ content_for_additional_checkout_buttons }}
              </div>
              {%- endif -%}
            </div>
            
            {%- comment -%} Payment Icons {%- endcomment -%}
            <div class="payment-icons">
              <span class="payment-label">{{ 'cart.general.we_accept' | t | default: 'We accept' }}</span>
              <div class="payment-icons-row">
                <i class="fa-brands fa-cc-visa" title="Visa"></i>
                <i class="fa-brands fa-cc-mastercard" title="Mastercard"></i>
                <i class="fa-brands fa-cc-amex" title="American Express"></i>
                <i class="fa-brands fa-cc-paypal" title="PayPal"></i>
                <i class="fa-brands fa-cc-apple-pay" title="Apple Pay"></i>
                <i class="fa-brands fa-google-pay" title="Google Pay"></i>
              </div>
            </div>
            
            {%- comment -%} Trust Badges {%- endcomment -%}
            <div class="trust-badges">
              <div class="trust-badge">
                <i class="fa-solid fa-shield-halved"></i>
                <span>{{ 'cart.trust.ssl_secure' | t | default: 'SSL Secure' }}</span>
              </div>
              <div class="trust-badge">
                <i class="fa-solid fa-rotate-left"></i>
                <span>{{ 'cart.trust.easy_returns' | t | default: 'Easy Returns' }}</span>
              </div>
              <div class="trust-badge">
                <i class="fa-solid fa-truck-fast"></i>
                <span>{{ 'cart.trust.fast_shipping' | t | default: 'Fast Shipping' }}</span>
              </div>
              <div class="trust-badge">
                <i class="fa-solid fa-headset"></i>
                <span>{{ 'cart.trust.support' | t | default: '24/7 Support' }}</span>
              </div>
            </div>
            
          </div>
        </div>
        
      </form>

      {%- comment -%} ═══ CROSS-SELL RECOMMENDATIONS ═══ {%- endcomment -%}
      <section class="cart-recommendations">
        <div class="recommendations-header">
          <div class="rec-header-left">
            <i class="fa-solid fa-fire"></i>
            <h3>{{ 'cart.recommendations.title' | t | default: 'You May Also Like' }}</h3>
          </div>
          <a href="{{ routes.all_products_collection_url }}" class="rec-view-all">
            {{ 'cart.recommendations.view_all' | t | default: 'View All' }}
            <i class="fa-solid fa-arrow-right"></i>
          </a>
        </div>
        
        <div class="recommendations-grid" id="cart-recommendations">
          {%- comment -%} Loaded dynamically via Shopify Recommendations API {%- endcomment -%}
          <div class="rec-loading">
            <div class="rec-skeleton"></div>
            <div class="rec-skeleton"></div>
            <div class="rec-skeleton"></div>
            <div class="rec-skeleton"></div>
            <div class="rec-skeleton"></div>
          </div>
        </div>
      </section>

      {%- comment -%} ═══ MOBILE STICKY CHECKOUT BAR ═══ {%- endcomment -%}
      <div class="mobile-checkout-bar">
        <div class="mobile-bar-info">
          <span class="mobile-bar-label">{{ 'cart.general.total' | t | default: 'Total' }}</span>
          <span class="mobile-bar-total" id="mobile-total">{{ cart.total_price | money }}</span>
        </div>
        <button type="submit" form="cart-form" name="checkout" class="mobile-checkout-btn">
          <i class="fa-solid fa-lock"></i>
          {{ 'cart.general.checkout' | t | default: 'Checkout' }}
        </button>
      </div>

    {%- else -%}

      {%- comment -%} ═══ EMPTY CART ═══ {%- endcomment -%}
      <div class="cart-empty-state">
        <div class="empty-icon">
          <i class="fa-solid fa-cart-shopping"></i>
        </div>
        <h2>{{ 'cart.general.empty_title' | t | default: 'Your cart is empty' }}</h2>
        <p>{{ 'cart.general.empty_description' | t | default: "Looks like you haven't added anything to your cart yet." }}</p>
        <a href="{{ routes.all_products_collection_url }}" class="empty-shop-btn">
          <i class="fa-solid fa-bag-shopping"></i>
          {{ 'cart.general.start_shopping' | t | default: 'Start Shopping' }}
        </a>
        
        {%- comment -%} Featured Products for Empty Cart {%- endcomment -%}
        <div class="empty-cart-featured">
          <h3>{{ 'cart.general.popular_products' | t | default: 'Popular Products' }}</h3>
          <div class="featured-products-grid" id="empty-cart-products">
            {%- comment -%} Load dynamically {%- endcomment -%}
          </div>
        </div>
      </div>

    {%- endif -%}

  </div>
</div>

{%- comment -%} ═══ CART JAVASCRIPT ═══ {%- endcomment -%}
<script>
(function() {
  'use strict';
  
  const moneyFormat = {{ shop.money_format | json }};
  const freeShippingThreshold = {{ free_shipping_threshold }};
  const cartItemsProductIds = {{ cart.items | map: 'product_id' | json }};
  const firstProductId = cartItemsProductIds[0] || null;
  
  // Format money helper
  function formatMoney(cents) {
    const amount = (cents / 100).toFixed(2);
    return moneyFormat
      .replace(/\{\{\s*amount\s*\}\}/g, amount)
      .replace(/\{\{\s*amount_no_decimals\s*\}\}/g, Math.round(cents/100))
      .replace(/\{\{\s*amount_with_comma_separator\s*\}\}/g, amount.replace('.', ','));
  }
  
  // Update cart display
  function updateCartDisplay(cart) {
    // Update subtotal & total
    document.getElementById('cart-subtotal').textContent = formatMoney(cart.total_price);
    document.getElementById('cart-total').textContent = formatMoney(cart.total_price);
    document.getElementById('mobile-total').textContent = formatMoney(cart.total_price);
    
    // Update item count
    document.querySelectorAll('.cart-item-count').forEach(el => {
      el.textContent = `(${cart.item_count} ${cart.item_count === 1 ? 'item' : 'items'})`;
    });
    document.querySelectorAll('.items-count-badge').forEach(el => {
      el.textContent = cart.item_count;
    });
    
    // Update header cart badges
    document.querySelectorAll('.cart-count, .cart-badge, #drawerCount, #navCartBadge').forEach(el => {
      el.textContent = cart.item_count;
    });
    
    // Update shipping display
    const shippingEl = document.getElementById('cart-shipping');
    if (shippingEl) {
      if (cart.total_price >= freeShippingThreshold) {
        shippingEl.innerHTML = '<span class="free-badge">FREE</span>';
      } else {
        shippingEl.textContent = 'Calculated at checkout';
      }
    }
    
    // Update free shipping progress bar
    updateShippingProgress(cart.total_price);
    
    // Update checkout button total
    document.querySelectorAll('.checkout-total').forEach(el => {
      el.textContent = formatMoney(cart.total_price);
    });
    
    // Update line item totals
    cart.items.forEach(item => {
      const lineTotal = document.querySelector(`.line-item-total[data-key="${item.key}"]`);
      if (lineTotal) {
        lineTotal.textContent = formatMoney(item.final_line_price);
      }
    });
    
    // Reload if empty
    if (cart.item_count === 0) {
      location.reload();
    }
  }
  
  // Update shipping progress bar
  function updateShippingProgress(totalPrice) {
    const remaining = freeShippingThreshold - totalPrice;
    const progress = Math.min((totalPrice / freeShippingThreshold) * 100, 100);
    
    const progressFill = document.querySelector('.shipping-progress-fill');
    const progressIcon = document.querySelector('.shipping-progress-icon');
    const barText = document.querySelector('.shipping-bar-text');
    
    if (progressFill) progressFill.style.width = `${progress}%`;
    if (progressIcon) progressIcon.style.left = `${progress}%`;
    
    if (barText) {
      if (remaining > 0) {
        barText.classList.remove('qualified');
        barText.innerHTML = `
          <i class="fa-solid fa-truck-fast"></i>
          <span>Add <strong>${formatMoney(remaining)}</strong> more for FREE shipping!</span>
        `;
      } else {
        barText.classList.add('qualified');
        barText.innerHTML = `
          <i class="fa-solid fa-circle-check"></i>
          <span>Congratulations! You've qualified for FREE shipping!</span>
        `;
      }
    }
  }
  
  // Cart API update
  function updateCart(key, quantity) {
    return fetch('/cart/change.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: key, quantity: quantity })
    })
    .then(r => r.json())
    .then(cart => {
      updateCartDisplay(cart);
      return cart;
    });
  }
  
  // Quantity buttons
  document.querySelectorAll('.qty-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const key = this.dataset.key;
      const input = document.querySelector(`.qty-input[data-key="${key}"]`);
      let val = parseInt(input.value) || 1;
      
      if (this.classList.contains('qty-plus')) {
        val++;
      } else if (this.classList.contains('qty-minus') && val > 1) {
        val--;
      }
      
      input.value = val;
      updateCart(key, val);
    });
  });
  
  // Quantity input change
  document.querySelectorAll('.qty-input').forEach(input => {
    input.addEventListener('change', function() {
      const key = this.dataset.key;
      const val = parseInt(this.value) || 1;
      this.value = Math.max(1, val);
      updateCart(key, this.value);
    });
  });
  
  // Remove buttons
  document.querySelectorAll('.line-item-remove').forEach(btn => {
    btn.addEventListener('click', function() {
      const key = this.dataset.key;
      const lineItem = this.closest('.cart-line-item');
      
      // Animate removal
      lineItem.style.opacity = '0';
      lineItem.style.transform = 'translateX(-20px)';
      
      updateCart(key, 0).then(() => {
        lineItem.remove();
      });
    });
  });
  
  // Coupon toggle
  const couponHeader = document.querySelector('[data-toggle-coupon]');
  const couponWrap = document.querySelector('.coupon-input-wrap');
  if (couponHeader && couponWrap) {
    couponHeader.addEventListener('click', function() {
      const isVisible = couponWrap.style.display !== 'none';
      couponWrap.style.display = isVisible ? 'none' : 'flex';
      this.querySelector('.coupon-toggle-icon').style.transform = isVisible ? '' : 'rotate(180deg)';
    });
  }
  
  // Urgency timer
  const urgencyBanner = document.querySelector('.cart-urgency-banner');
  if (urgencyBanner) {
    let minutes = parseInt(urgencyBanner.dataset.minutes) || 15;
    let seconds = 0;
    const countdown = urgencyBanner.querySelector('.urgency-countdown');
    
    setInterval(() => {
      if (seconds === 0) {
        if (minutes === 0) return;
        minutes--;
        seconds = 59;
      } else {
        seconds--;
      }
      countdown.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }, 1000);
  }
  
  // Load recommendations
  function loadRecommendations() {
    if (!firstProductId) return;
    
    fetch(`/recommendations/products.json?product_id=${firstProductId}&limit=5`)
      .then(r => r.json())
      .then(data => {
        const container = document.getElementById('cart-recommendations');
        if (!container || !data.products || data.products.length === 0) return;
        
        container.innerHTML = data.products.map(product => `
          <div class="rec-product-card">
            <a href="${product.url}" class="rec-product-image">
              <img src="${product.featured_image || product.images[0]}" alt="${product.title}" loading="lazy">
            </a>
            <div class="rec-product-info">
              <a href="${product.url}" class="rec-product-title">${product.title}</a>
              <div class="rec-product-price">
                ${product.compare_at_price > product.price 
                  ? `<span class="rec-price-sale">${formatMoney(product.price)}</span>
                     <span class="rec-price-compare">${formatMoney(product.compare_at_price)}</span>`
                  : `<span class="rec-price">${formatMoney(product.price)}</span>`
                }
              </div>
              <button type="button" class="rec-add-btn" data-variant-id="${product.variants[0].id}">
                <i class="fa-solid fa-plus"></i>
                Add
              </button>
            </div>
          </div>
        `).join('');
        
        // Add to cart handlers
        container.querySelectorAll('.rec-add-btn').forEach(btn => {
          btn.addEventListener('click', function() {
            const variantId = this.dataset.variantId;
            this.disabled = true;
            this.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            
            fetch('/cart/add.js', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ id: variantId, quantity: 1 })
            })
            .then(r => r.json())
            .then(() => {
              location.reload();
            });
          });
        });
      });
  }
  
  loadRecommendations();
  
})();
</script>
