{% comment %}
  ============================================
  Delivery Calculator - Global Configuration
  ============================================

  Bu snippet, tema ayarlarÄ±ndan alÄ±nan deÄŸerleri
  JavaScript konfigÃ¼rasyonuna aktarÄ±r.

  KullanÄ±m:
  {% render 'delivery-config' %}

  Bu snippet'i theme.liquid veya layout dosyasÄ±nÄ±n
  </body> tagÄ±ndan hemen Ã¶nce ekleyin.

{% endcomment %}

{% liquid
  # Enable kontrolÃ¼
  assign delivery_enabled = settings.delivery_enabled | default: false
%}

{% if delivery_enabled %}
{% liquid
  # Tema ayarlarÄ±ndan deÄŸerler (settings_schema.json'da tanÄ±mlanmalÄ±)
  assign cutoff_hour = settings.delivery_cutoff_hour | default: 14
  assign cutoff_minute = settings.delivery_cutoff_minute | default: 0
  assign default_carrier = settings.delivery_default_carrier | default: 'ups_ground'
  assign express_enabled = settings.delivery_express_enabled | default: true
  assign weekend_delivery = settings.delivery_weekend | default: false
  assign debug_mode = settings.delivery_debug | default: false

  # Depo lokasyonlarÄ±
  assign warehouse_1_enabled = settings.warehouse_1_enabled | default: true
  assign warehouse_1_id = settings.warehouse_1_id | default: 'east'
  assign warehouse_1_name = settings.warehouse_1_name | default: 'East Coast Warehouse'
  assign warehouse_1_zip = settings.warehouse_1_zip | default: '07001'
  assign warehouse_1_state = settings.warehouse_1_state | default: 'NJ'

  assign warehouse_2_enabled = settings.warehouse_2_enabled | default: false
  assign warehouse_2_id = settings.warehouse_2_id | default: 'west'
  assign warehouse_2_name = settings.warehouse_2_name | default: 'West Coast Warehouse'
  assign warehouse_2_zip = settings.warehouse_2_zip | default: '90001'
  assign warehouse_2_state = settings.warehouse_2_state | default: 'CA'

  # Ã–zel tatil gÃ¼nleri
  assign custom_holidays = settings.delivery_holidays | default: ''

  # Widget Display Settings
  assign widget_location_text = settings.delivery_widget_location_text | default: 'NJ'
  assign widget_pickup_location = settings.delivery_widget_pickup_location | default: 'Garfield, NJ'
  assign widget_pickup_map_url = settings.delivery_widget_pickup_map_url | default: 'https://maps.app.goo.gl/CRMkNFqWB57YPpxG6'
  assign widget_pickup_bg = settings.delivery_widget_pickup_bg | default: '#fef3c7'
  assign widget_pickup_border = settings.delivery_widget_pickup_border | default: '#fbbf24'
  assign widget_success_color = settings.delivery_widget_success_color | default: '#22c55e'
  assign widget_mobile_collapsed = settings.delivery_widget_mobile_collapsed | default: true
  assign widget_mobile_title = settings.delivery_widget_mobile_title | default: 'ðŸšš Shipping Info'
%}

<script>
window.DELIVERY_CONFIG = {
  // Cut-off ayarlarÄ±
  cutoffHour: {{ cutoff_hour }},
  cutoffMinute: {{ cutoff_minute }},
  timezone: 'America/New_York',

  // VarsayÄ±lan kargo
  defaultCarrier: {{ default_carrier | json }},

  // Ã–zellikler
  expressEnabled: {{ express_enabled | json }},
  weekendDelivery: {{ weekend_delivery | json }},
  debug: {{ debug_mode | json }},

  // Depolar
  warehouses: [
    {% if warehouse_1_enabled %}
    {
      id: {{ warehouse_1_id | json }},
      name: {{ warehouse_1_name | json }},
      zipCode: {{ warehouse_1_zip | json }},
      state: {{ warehouse_1_state | json }}
    }{% if warehouse_2_enabled %},{% endif %}
    {% endif %}
    {% if warehouse_2_enabled %}
    {
      id: {{ warehouse_2_id | json }},
      name: {{ warehouse_2_name | json }},
      zipCode: {{ warehouse_2_zip | json }},
      state: {{ warehouse_2_state | json }}
    }
    {% endif %}
  ],

  // Ã–zel tatil gÃ¼nleri
  customHolidays: {{ custom_holidays | split: ',' | json }},

  // Widget Display Settings
  display: {
    locationText: {{ widget_location_text | json }},
    pickupLocation: {{ widget_pickup_location | json }},
    pickupMapUrl: {{ widget_pickup_map_url | json }},
    colors: {
      pickupBg: {{ widget_pickup_bg | json }},
      pickupBorder: {{ widget_pickup_border | json }},
      success: {{ widget_success_color | json }}
    },
    mobile: {
      collapsed: {{ widget_mobile_collapsed | json }},
      title: {{ widget_mobile_title | json }}
    }
  }
};

// Calculator'Ä± baÅŸlat - Hybrid Mode (Live Shopify Rates + Static Fallback)
document.addEventListener('DOMContentLoaded', function() {
  // Statik calculator her zaman hazÄ±r
  if (typeof DeliveryCalculator !== 'undefined') {
    window.staticDeliveryCalculator = new DeliveryCalculator(window.DELIVERY_CONFIG);
  }

  // Hybrid calculator (Ã¶nce live rates, sonra fallback)
  if (typeof HybridDeliveryCalculator !== 'undefined' && typeof DeliveryCalculator !== 'undefined') {
    window.deliveryCalculator = new HybridDeliveryCalculator({
      static: window.DELIVERY_CONFIG,
      live: {
        debug: window.DELIVERY_CONFIG.debug,
        cacheDuration: 300000, // 5 dakika
        maxRetries: 3
      },
      preferLiveRates: true,
      fallbackToStatic: true,
      debug: window.DELIVERY_CONFIG.debug
    });

    console.log('[Delivery] Hybrid mode initialized - Live Shopify rates enabled');
  } else if (window.staticDeliveryCalculator) {
    // Fallback: sadece statik calculator
    window.deliveryCalculator = window.staticDeliveryCalculator;
    console.log('[Delivery] Static mode initialized');
  }

  // Custom event fÄ±rlat
  if (window.deliveryCalculator) {
    document.dispatchEvent(new CustomEvent('delivery:ready', {
      detail: {
        calculator: window.deliveryCalculator,
        mode: typeof HybridDeliveryCalculator !== 'undefined' ? 'hybrid' : 'static'
      }
    }));
  }
});
</script>
{% endif %}